Index: avatars.cpp
===================================================================
--- avatars.cpp	(revision 88)
+++ avatars.cpp	(working copy)
@@ -95,12 +95,28 @@
 			std::string file_name = GetAvatarFolder() + '\\' + dbv.pszVal + ext;
 			DBFreeVariant(&dbv);
 
-			if ( file_name.length() )
+			if ( file_name.length() && !_access(file_name.c_str(), 0) ) {
 				strncpy((char*)wParam, file_name.c_str(), (int)lParam);
-			
-			if (!_access((char*)wParam, 0)) return 0; // Avatar file exists
+				return 0; // Avatar file exists
+			}
 			return -1; // Avatar file doesn't exist
 		}
 	}
 	return -2; // No avatar set
 }
+
+// RM TODO: p¯epsat fbu na string, vracet int, pouûÌt v hornÌ funkci, aù nenÌ zbyteËn· redundance
+bool FacebookProto::AvatarExists(facebook_user* fbu)
+{
+	if (fbu == NULL) return false;
+
+	std::string ext = fbu->image_url.substr(fbu->image_url.rfind('.'));
+	std::string file_name = GetAvatarFolder() + '\\' + fbu->user_id + ext;
+
+	if ( file_name.length() ) {
+		if (!_access(file_name.c_str(), 0)) return false; // Avatar file exists, we doesn't need refresh
+	} else return false;
+
+	return true; // Avatar file doesn't exist, we need refresh
+}
+
Index: client.h
===================================================================
--- client.h	(revision 88)
+++ client.h	(working copy)
@@ -48,6 +48,8 @@
 
 		chat_first_touch_ = false;
 
+		idle_ = false;
+
 		buddies_lock_ = NULL;
 	}
 
@@ -67,6 +69,7 @@
 	std::string chat_channel_host_;
 	unsigned int    chat_sequence_num_;
 	bool    chat_first_touch_;
+	bool	idle_;
 	time_t  last_feeds_update_;
 
 	bool api_check( );
@@ -75,7 +78,7 @@
 
 	// Client vs protocol communication
 
-	void    client_notify( TCHAR* message, DWORD flag = NIIF_INFO );
+	void    client_notify( TCHAR* message );
 
 	////////////////////////////////////////////////////////////
 
@@ -142,6 +145,7 @@
 
 	bool    channel( );
 	bool    send_message( std::string message_recipient, std::string message_text );
+	void    close_chat( std::string message_recipient );
 
 	////////////////////////////////////////////////////////////
 
Index: common.h
===================================================================
--- common.h	(revision 88)
+++ common.h	(working copy)
@@ -50,6 +50,8 @@
 
 #include <windows.h>
 
+#include <commctrl.h>
+
 #include <newpluginapi.h>
 #include <win2k.h>
 #include <m_system.h>
Index: communication.cpp
===================================================================
--- communication.cpp	(revision 88)
+++ communication.cpp	(working copy)
@@ -3,7 +3,7 @@
 Facebook plugin for Miranda Instant Messenger
 _____________________________________________
 
-Copyright © 2009-10 Michal Zelinka
+Copyright ÔøΩ 2009-10 Michal Zelinka
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
@@ -27,9 +27,9 @@
 
 #include "common.h"
 
-void facebook_client::client_notify( TCHAR* message, DWORD flags )
+void facebook_client::client_notify( TCHAR* message )
 {
-	parent->NotifyEvent( parent->m_tszUserName, message, NULL, flags );
+	parent->NotifyEvent( parent->m_tszUserName, message, 0, FACEBOOK_EVENT_CLIENT );
 }
 
 http::response facebook_client::flap( const int request_type, std::string* request_data )
@@ -85,7 +85,7 @@
 		int error_num = atoi( error.substr( 0, error.find( "," ) ).c_str() );
 		if ( error_num != 0 )
 		{
-			error = error.substr( error.find( "\"errorDescription\":\"" ) + 20 );
+			error = error.substr( error.find( "\"errorDescription\":\"" ) + 40 );
 			error = error.substr( 0, error.find( "\"," ) );
 			parent->Log(" ! !  Received Facebook error: %d -- %s", error_num, error.c_str());
 			resp->code = HTTP_CODE_FAKE_LOGGED_OUT;
@@ -124,7 +124,9 @@
 		result = false;
 
 	if ( result == false ) {
-		reset_error(); parent->SetStatus(ID_STATUS_OFFLINE); }
+		reset_error();
+		parent->SetStatus(ID_STATUS_OFFLINE);
+	}
 
 	return result;
 }
@@ -149,6 +151,8 @@
 	case FACEBOOK_REQUEST_PROFILE_GET:
 	case FACEBOOK_REQUEST_STATUS_SET:
 	case FACEBOOK_REQUEST_MESSAGE_SEND:
+	case FACEBOOK_REQUEST_SETTINGS:
+	case FACEBOOK_REQUEST_TYPING:
 	default:
 		return ( DWORD )0;
 	}
@@ -164,10 +168,12 @@
 	case FACEBOOK_REQUEST_BUDDY_LIST:
 	case FACEBOOK_REQUEST_STATUS_SET:
 	case FACEBOOK_REQUEST_MESSAGE_SEND:
+	case FACEBOOK_REQUEST_SETTINGS:
+	case FACEBOOK_REQUEST_TYPING:
+	case FACEBOOK_REQUEST_LOGOUT:
 		return REQUEST_POST;
 
 	case FACEBOOK_REQUEST_API_CHECK:
-	case FACEBOOK_REQUEST_LOGOUT:
 	case FACEBOOK_REQUEST_HOME:
 	case FACEBOOK_REQUEST_FEEDS:
 	case FACEBOOK_REQUEST_RECONNECT:
@@ -179,7 +185,7 @@
 
 std::string facebook_client::choose_proto( int request_type )
 {
-	if ( DBGetContactSettingByte( NULL, parent->m_szProtoName, FACEBOOK_KEY_FORCE_HTTPS, 0 ) )
+	if ( DBGetContactSettingByte( NULL, parent->m_szProtoName, FACEBOOK_KEY_USE_HTTPS, 0 ) )
 		return HTTP_PROTO_SECURE;
 
 	switch ( request_type )
@@ -195,6 +201,8 @@
 	case FACEBOOK_REQUEST_BUDDY_LIST:
 	case FACEBOOK_REQUEST_STATUS_SET:
 	case FACEBOOK_REQUEST_MESSAGE_SEND:
+	case FACEBOOK_REQUEST_SETTINGS:
+	case FACEBOOK_REQUEST_TYPING:
 	default:
 		return HTTP_PROTO_REGULAR;
 
@@ -220,9 +228,10 @@
 		utils::text::replace_first( &server, "%s", this->chat_channel_host_ );
 		return server; }
 
-	case FACEBOOK_REQUEST_PROFILE_GET:
-		return FACEBOOK_SERVER_MOBILE;
+/*	case FACEBOOK_REQUEST_PROFILE_GET:
+		return FACEBOOK_SERVER_MOBILE;*/
 
+  case FACEBOOK_REQUEST_PROFILE_GET:
 	case FACEBOOK_REQUEST_LOGOUT:
 	case FACEBOOK_REQUEST_KEEP_ALIVE:
 	case FACEBOOK_REQUEST_HOME:
@@ -231,6 +240,8 @@
 	case FACEBOOK_REQUEST_RECONNECT:
 	case FACEBOOK_REQUEST_STATUS_SET:
 	case FACEBOOK_REQUEST_MESSAGE_SEND:
+	case FACEBOOK_REQUEST_SETTINGS:
+	case FACEBOOK_REQUEST_TYPING:
 	default:
 		return FACEBOOK_SERVER_REGULAR;
 	}
@@ -253,13 +264,13 @@
 		return "/logout.php";
 
 	case FACEBOOK_REQUEST_KEEP_ALIVE:
-		return "/ajax/presence/update.php";
+		return "/ajax/presence/update.php?__a=1";
 
 	case FACEBOOK_REQUEST_HOME:
 		return "/home.php?";
 
 	case FACEBOOK_REQUEST_BUDDY_LIST:
-		return "/ajax/chat/buddy_list.php";
+		return "/ajax/chat/buddy_list.php?__a=1";
 
 	case FACEBOOK_REQUEST_FEEDS: {
 		// Filters: lf = live feed, h = news feed
@@ -276,16 +287,21 @@
 		utils::text::replace_first( &action, "%s", this->post_form_id_ );
 		return action; }
 
-	case FACEBOOK_REQUEST_PROFILE_GET: {
+/*	case FACEBOOK_REQUEST_PROFILE_GET: {
 		std::string action = "/profile.php?id=%s&v=info";
 		utils::text::replace_first( &action, "%s", (*data) );
+		return action; }*/
+
+  case FACEBOOK_REQUEST_PROFILE_GET: {
+		std::string action = "/ajax/hovercard/user.php?id=%s&__a=1";
+		utils::text::replace_first( &action, "%s", (*data) );
 		return action; }
 
 	case FACEBOOK_REQUEST_STATUS_SET:
-		return "/ajax/updatestatus.php";
+		return "/ajax/updatestatus.php?__a=1";
 
 	case FACEBOOK_REQUEST_MESSAGE_SEND:
-		return "/ajax/chat/send.php";
+		return "/ajax/chat/send.php?__a=1";
 
 	case FACEBOOK_REQUEST_MESSAGES_RECEIVE: {
 		std::string action = "/x/%s/%s/p_%s=%d";
@@ -298,6 +314,12 @@
 		utils::text::replace_first( &action, "%d", utils::conversion::to_string( (void*)&chat_sequence_num_, UTILS_CONV_UNSIGNED_NUMBER ) );
 		return action; }
 
+	case FACEBOOK_REQUEST_SETTINGS: 
+		return "/ajax/chat/settings.php?__a=1";
+
+	case FACEBOOK_REQUEST_TYPING:
+		return "/ajax/chat/typ.php?__a=1";
+
 	default:
 		return "/";
 	}
@@ -308,6 +330,8 @@
 	std::string url = choose_proto( request_type );
 	url.append( choose_server( request_type, data ) );
 	url.append( choose_action( request_type, data ) );
+	/*if (DBGetContactSettingByte(NULL,parent->m_szModuleName,FACEBOOK_KEY_USE_HTTPS, 0)) {
+		utils::text::replace_first( &url, "http://", "https://" ); }*/
 	return url;
 }
 
@@ -324,6 +348,8 @@
 	case FACEBOOK_REQUEST_PROFILE_GET:
 	case FACEBOOK_REQUEST_STATUS_SET:
 	case FACEBOOK_REQUEST_MESSAGE_SEND:
+	case FACEBOOK_REQUEST_SETTINGS:
+	case FACEBOOK_REQUEST_TYPING:
 		*headers_count = 7;
 		break;
 	case FACEBOOK_REQUEST_HOME:
@@ -350,6 +376,8 @@
 	case FACEBOOK_REQUEST_PROFILE_GET:
 	case FACEBOOK_REQUEST_STATUS_SET:
 	case FACEBOOK_REQUEST_MESSAGE_SEND:
+	case FACEBOOK_REQUEST_SETTINGS:
+	case FACEBOOK_REQUEST_TYPING:
 		set_header( &headers[6], "Content-Type" );
 	case FACEBOOK_REQUEST_HOME:
 	case FACEBOOK_REQUEST_RECONNECT:
@@ -498,8 +526,10 @@
 	data += utils::url::encode( username );
 	data += "&pass=";
 	data += utils::url::encode( password );
-	data += "&pass_placeHolder=Password&persistent=1&login=Login&charset_test=%e2%82%ac%2c%c2%b4%2c%e2%82%ac%2c%c2%b4%2c%e6%b0%b4%2c%d0%94%2c%d0%84";
+	data += "&pass_placeHolder=Password&login=Login";
 
+//persistent=1
+
 	// Send validation
 	http::response resp = flap( FACEBOOK_REQUEST_LOGIN, &data );
 
@@ -516,7 +546,31 @@
 	{
 
 	case HTTP_CODE_OK: // OK page returned, but that is regular login page we don't want in fact
-		client_notify(TranslateT("Probably wrong password entered, please try again."));
+		{
+			// Zjistneni realne chyby prihlseni
+			std::string::size_type start, end;
+			std::string error_str;
+
+			// Get error message
+			start = resp.data.find( "id=\"standard_error\"" );
+			end = resp.data.find( "</", start );
+			start = resp.data.rfind( "\">", end ) + 2;
+			error_str = resp.data.substr( start, end - start );
+
+			parent->Log(" ! !  Login error: %s", error_str.c_str());
+
+			TCHAR* message = TranslateT( "Login error: " );
+			TCHAR* error = mir_a2t_cp( error_str.c_str( ), CP_UTF8 );
+			TCHAR* info = ( TCHAR* )malloc( ( lstrlen( message ) + lstrlen( error ) ) * sizeof( TCHAR ) );
+			lstrcpy( info, message );
+			lstrcat( info, error );
+		
+			client_notify( info );
+
+			mir_free( message );
+			mir_free( error );
+			mir_free( info );
+		}
 	case HTTP_CODE_FORBIDDEN: // Forbidden
 	case HTTP_CODE_NOT_FOUND: // Not Found
 	default:
@@ -545,8 +599,16 @@
 
 	handle_entry( "logout" );
 
-	http::response resp = flap( FACEBOOK_REQUEST_LOGOUT );
+  std::string data = "post_form_id=";
+	data += ( this->post_form_id_.length( ) ) ? this->post_form_id_ : "0";
+  data += "&fb_dtsg=";
+  data += ( this->dtsg_.length( ) ) ? this->dtsg_ : "0";
+  data += "&ref=mb"; // jeste tam je &h=nejakyhash
 
+// RM TODO: doopravit odhlasovaci proceduru - mozna ten hash, mozna je potreba jeste nacist ten dalsi index...
+
+  http::response resp = flap( FACEBOOK_REQUEST_LOGOUT, &data );
+
 	// Process result
 	username_ = password_ = self_.user_id = "";
 
@@ -558,8 +620,7 @@
 		return handle_success( "logout" );
 
 	default:
-		return handle_error( "logout", FORCE_DISCONNECT );
-
+		return false; // RM: jarvisovo handle_error( "logout", FORCE_DISCONNECT ); zpusobi zbytecnou divnou rekurzi
 	}
 }
 
@@ -570,7 +631,7 @@
 
 	handle_entry( "keep_alive" );
 
-	std::string data = "user=" + this->self_.user_id + "&popped_out=false&force_render=true&buddy_list=1&notifications=0&post_form_id=" + this->post_form_id_ + "&fb_dtsg=" + this->dtsg_ + "&post_form_id_source=AsyncRequest&__a=1&nctr[n]=1";
+  std::string data = "user=" + this->self_.user_id + "&popped_out=false&force_render=true&buddy_list=1&notifications=0&post_form_id=" + this->post_form_id_ + "&fb_dtsg=" + this->dtsg_ + "&post_form_id_source=AsyncRequest&__a=1&nctr[n]=1";
 
 	{
 		ScopedLock s(buddies_lock_);
@@ -640,7 +701,7 @@
 			parent->Log("      Got self dtsg: %s", this->dtsg_.c_str());
 
 			// Get friend requests count and messages count and notify it
-			if ( DBGetContactSettingByte( NULL, parent->m_szModuleName, FACEBOOK_KEY_NOTIFICATIONS_ENABLE, 0 ) ) {
+			if ( DBGetContactSettingByte( NULL, parent->m_szModuleName, FACEBOOK_KEY_OTHER_ENABLE, DEFAULT_OTHER_ENABLE ) ) {
 				start = resp.data.find( "<span id=\"jewelRequestCount\">" );
 				if ( start != std::string::npos ) {
 					start += 29;
@@ -652,7 +713,7 @@
 						TCHAR* info = ( TCHAR* )malloc( ( lstrlen( message ) + lstrlen( count ) ) * sizeof( TCHAR ) );
 						lstrcpy( info, message );
 						lstrcat( info, count );
-						this->parent->NotifyEvent( this->parent->m_tszUserName, info );
+						this->parent->NotifyEvent( this->parent->m_tszUserName, info, 0, FACEBOOK_EVENT_OTHER, reinterpret_cast<TCHAR *> ( FACEBOOK_URL_REQUESTS ) );
 						mir_free( message );
 						mir_free( count );
 						mir_free( info ); } }
@@ -668,7 +729,7 @@
 						TCHAR* info = ( TCHAR* )malloc( ( lstrlen( message ) + lstrlen( count ) ) * sizeof( TCHAR ) );
 						lstrcpy( info, message );
 						lstrcat( info, count );
-						this->parent->NotifyEvent( this->parent->m_tszUserName, info );
+						this->parent->NotifyEvent( this->parent->m_tszUserName, info, 0, FACEBOOK_EVENT_OTHER, reinterpret_cast<TCHAR *> ( FACEBOOK_URL_MESSAGES )  );
 						mir_free( message );
 						mir_free( count );
 						mir_free( info ); } }
@@ -683,13 +744,14 @@
 			return handle_success( "home" );
 		}
 		else {
-			client_notify(TranslateT("Something happened to Facebook. Maybe there was some major update so you should wait for an update, or you have Facebook Lite set as default."));
+			// smazano z te hlasky facebook lite, protoze uz je zruseny
+			client_notify(TranslateT("Something happened to Facebook. Maybe there was some major update so you should wait for an update."));
 			return handle_error( "home", FORCE_DISCONNECT );
 		}
 
-	case HTTP_CODE_FOUND:
+/*	case HTTP_CODE_FOUND:
 		// Work-around for replica_down, f**king hell what's that?
-		return this->home();
+		return this->home();*/ // TODO RM: uhm, rekurze? zase takovej fuj :) a asi uz zbytecnej
 
 	default:
 		return handle_error( "home", FORCE_DISCONNECT );
@@ -701,7 +763,19 @@
 {
 	handle_entry( "reconnect" );
 
-	http::response resp = flap( FACEBOOK_REQUEST_RECONNECT );
+  // Set online "status" for chat - konkr√©tnƒõ tohle "zapne" chat, pokud je na str√°nce z minula vypnutej
+  // RM TODO: mo≈æn√° by se to mohlo dƒõlat i u odhla≈°ov√°n√≠?
+  std::string data = "visibility=true";
+	data += "&window_id=0";
+	data += "&post_form_id=";
+	data += ( post_form_id_.length( ) ) ? post_form_id_ : "0";
+	data += "&post_form_id_source=AsyncRequest";
+  data += "&fb_dtsg=" + this->dtsg_;
+  data += "&lsd=";
+	http::response resp = flap( FACEBOOK_REQUEST_SETTINGS, &data );
+  
+  // Request reconnect
+  resp = flap( FACEBOOK_REQUEST_RECONNECT );
 
 	// Process result data
 	validate_response(&resp);
@@ -743,7 +817,8 @@
 			data += "&available_list[";
 			data += i->data->user_id;
 			data += "][i]=";
-			data += ( i->data->is_idle ) ? "1" : "0"; } }
+			data += ( i->data->is_idle ) ? "1" : "0"; }
+	}
 
 	// Get buddy list
 	http::response resp = flap( FACEBOOK_REQUEST_BUDDY_LIST, &data );
@@ -816,8 +891,15 @@
 	else if ( resp.data.find( "\"t\":\"refresh\"" ) != std::string::npos )
 	{
 		// Something went wrong with the session (has expired?), refresh it
-		this->reconnect( );
+		return this->reconnect( );
 	}
+	else if ( resp.data.find( "\"t\":\"fullReload\"" ) != std::string::npos )
+	{
+		// Something went wrong - too spam for server?
+		return this->reconnect( );
+
+		// for (;;);{"t":"fullReload", "seq":67,"reason":113}  // 113 = byl pozadavek o moc stary seq number
+	}
 	else
 	{
 		// Something has been received, throw to new thread to process
@@ -835,18 +917,12 @@
 	case HTTP_CODE_OK:
 		return handle_success( "channel" );
 
+	case HTTP_CODE_FAKE_DISCONNECTED: // dokud nesprav√≠ timeout v mirandƒõ nebo to nƒõkdo nep≈ôep√≠≈°e.. TODO RM
+		if (DBGetContactSettingByte(NULL, parent->m_szModuleName, FACEBOOK_KEY_IGNORE_CHANNEL_TIMEOUTS, 0))
+			return true;
 	case HTTP_CODE_FAKE_LOGGED_OUT:
-	case HTTP_CODE_FAKE_DISCONNECTED:
 	default:
-		return true;
-		// return handle_error( "channel" );
-		//
-		// Temporarily  (at least for this moment)  disabled due
-		// to core/NetLib  time-out  limit.  Because of the fact
-		// most  COMET transactions  are momentarily  marked  as
-		// timed-out before they can be returned back  or REALLY
-		// trully indicated as a time-out.
-
+		return handle_error( "channel" );
 	}
 }
 
@@ -862,13 +938,77 @@
 	data += message_recipient;
 	data += "&client_time=";
 	data += utils::time::mili_timestamp( );
+  data += "&to_offline=false";
 	data += "&post_form_id=";
 	data += ( post_form_id_.length( ) ) ? post_form_id_ : "0";
 
 	http::response resp = flap( FACEBOOK_REQUEST_MESSAGE_SEND, &data );
 
-	validate_response(&resp);
+  // RM TODO: prepsat validate_response aby vracelo v nejake strukture chybovy text, chybovy kod, atd.. aby se mohlo orientovat primo podle toho - nekdy je kontakt off, nekdy jina chyba, atd.
+  //validate_response(&resp);
+  // misto validate_response
+  if ( resp.code == HTTP_CODE_FAKE_DISCONNECTED ) {
+		parent->Log(" ! !  Request has timed out, connection or server error");
+  } else {
+	  if ( resp.data.find( "{\"error\":" ) != std::string::npos ) try
+	  {
+		  std::string error = resp.data.substr( resp.data.find( "{\"error\":" ) + 9, 128 );
+		  int error_num = atoi( error.substr( 0, error.find( "," ) ).c_str() );
+		  switch ( error_num )
+      {
+      case 0:
+        { // Everything is ok
+          break;
+        }
+      case 1356003:
+        { // Error - contact is offline!
+          // ERROR OFFLINE: for (;;);{"error":1356003,"errorSummary":"P\u0159\u00edjemce nen\u00ed online","errorDescription":"Va\u0161e zpr\u00e1va nebyla odesl\u00e1na, proto\u017ee P\u0159emysl nen\u00ed p\u0159ipojen(a).","errorIsWarning":false,"silentError":0,"payload":null}
 
+          HANDLE hContact = parent->ContactIDToHContact( message_recipient );
+      		DBWriteContactSettingWord(hContact,parent->m_szModuleName,"Status",ID_STATUS_OFFLINE);
+          
+          // Mohli bychom odeslat "ping", a zrejme overit, zdali je channel online...
+          // http://0.50.channel.facebook.com/p/ -> response: for (;;);{"t":"pong"}
+//          return false;
+//          break;
+        }
+      case 1356026:
+        { // Error - contact has different fb client than website and we have to approve sending messages to it...
+          // ERROR: for (;;);{"error":1356026,"errorSummary":"Chcete-li odeslat zpr\u00e1vu, zm\u011b\u0148te si nastaven\u00ed","errorDescription":"Tento u\u017eivatel pou\u017e\u00edv\u00e1 pro p\u0159\u00edstup k chatu aplikaci. Pro odesl\u00e1n\u00ed zpr\u00e1vy mus\u00edte zm\u011bnit sv\u00e9 nastaven\u00ed a povolit p\u0159\u00e1tele pou\u017e\u00edvaj\u00edc\u00ed aplikace, kter\u00e9 jim umo\u017e\u0148uj\u00ed vid\u011bt, kdy jste online.","errorIsWarning":false,"silentError":1,"payload":{"errorText":"Chcete-li odeslat zpr\u00e1vu, zm\u011b\u0148te si nastaven\u00ed","do_onload":"new Dialog()  .setTitle(\"Chcete-li odeslat zpr\\u00e1vu, zm\\u011b\\u0148te si nastaven\\u00ed\")  .setBody(\"P\\u0159emysl R\\u016f\\u017ei\\u010dka pro chatov\\u00e1n\\u00ed pou\\u017e\\u00edv\\u00e1 jinou aplikaci. Chcete-li mu poslat zpr\\u00e1vu, mus\\u00edte si upravit nastaven\\u00ed a povolit sv\\u00fdm p\\u0159\\u00e1tel\\u016fm pou\\u017eit\\u00ed aplikac\\u00ed tak, aby v\\u011bd\\u011bli, kdy jste online.\")  .setPostURI(\"\/ajax\/chat\/post_application_settings.php\")  .setExtraData({to_send: \"AQCoweMPeszBoKpd4iahcOyhmh0kiTYIhv1b5wCtuBiD0AaPVZIdEp3Pf5JMBmQ-9wf0ju-xdi-VRuk0ERk_I7XzI5dVJCs6-B0FExTZhspD-4-kTZLmZI-_M6fIuF2328yMyT3R3UEUmMV8P9MHcZwu-_pS3mOhsaHf6rIVcQ2rocSqLKi03wLKCfg0m8VsptPADWpOI-UNcIo-xl1PAoC1yVnL2wEXEtnF1qI_xFcmlJZ40AOONfIF_LS_lBrGYA-oCWLUK-GLHtQAHjO8aDeNXDU8Jk7Z_ES-_oAHee2PVLHcG_ACHXpasE7Iu3XFLMrdN2hjM96AjPRIf0Vk8gBZzfW_lUspakZmXxMI7iSNQE8lourK_6B3Z1s4UHxDZCNXYuc9gh70nm_xnaxnF9K1bR00s4MltnFjUT_3ypThzA\"})  .setButtons([    {name: \"enable_and_send\", label:\"Povolit a odeslat\"},    Dialog.CANCEL  ])  .show()"}}
+          /*
+          post na url http://www.facebook.com/ajax/chat/post_application_settings.php?__a=1
+
+          enable_and_send      Povolit a odeslat                                                                                                                                                                                                                                                                                                                                                                                                                               
+          to_send              AQCoweMPeszBoKpd4iahcOyhmh0kiTYIhv1b5wCtuBiD0AaPVZIdEp3Pf5JMBmQ-9wf0ju-xdi-VRuk0ERk_I7XzI5dVJCs6-B0FExTZhspD-4-kTZLmZI-_M6fIuF2328yMyT3R3UEUmMV8P9MHcZwu-_pS3mOhsaHf6rIVcQ2rocSqLKi03wLKCfg0m8VsptPADWpOI-UNcIo-xl1PAoC1yVnL2wEXEtnF1qI_xFcmlJZ40AOONfIF_LS_lBrGYA-oCWLUK-GLHtQAHjO8aDeNXDU8Jk7Z_ES-_oAHee2PVLHcG_ACHXpasE7Iu3XFLMrdN2hjM96AjPRIf0Vk8gBZzfW_lUspakZmXxMI7iSNQE8lourK_6B3Z1s4UHxDZCNXYuc9gh70nm_xnaxnF9K1bR00s4MltnFjUT_3ypThzA  
+          __d                  1                                                                                                                                                                                                                                                                                                                                                                                                                                               
+          post_form_id         c73ebd9d94b7449c40e6965410fcdcf6                                                                                                                                                                                                                                                                                                                                                                                                                
+          fb_dtsg              Tb-T9                                                                                                                                                                                                                                                                                                                                                                                                                                           
+          lsd                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
+          post_form_id_source  AsyncRequest                                                                                                                                                                                                                                                                                                                                                                                                                                    
+          */
+          error = error.substr( error.find( "\"errorDescription\":\"" ) + 40 );
+			    error = error.substr( 0, error.find( "\"," ) );
+			    parent->Log(" ! !  Received Facebook error: %d -- %s", error_num, error.c_str());
+          return false;
+          break;
+        }
+      default:
+        {
+			    error = error.substr( error.find( "\"errorDescription\":\"" ) + 40 );
+			    error = error.substr( 0, error.find( "\"," ) );
+			    parent->Log(" ! !  Received Facebook error: %d -- %s", error_num, error.c_str());
+  			  resp.code = HTTP_CODE_FAKE_LOGGED_OUT;
+        }
+      }
+	  } catch (const std::exception &e) {
+		  parent->Log(" @ @  validate_response: Exception: %s",e.what());
+    }
+  }
+
+	close_chat( message_recipient );
+  // todo: p≈ôepsat nƒõjak na forkthread :))
+  //	ForkThread( &FacebookProto::CloseChatWorker, this->parent, ( void *)data);
+
 	switch ( resp.code )
 	{
 
@@ -879,7 +1019,6 @@
 	case HTTP_CODE_FAKE_DISCONNECTED:
 	default:
 		return handle_error( "send_message" );
-
 	}
 
 }
@@ -897,7 +1036,7 @@
 
 	case HTTP_CODE_OK:
 		{
-			std::string::size_type start = resp.data.find( "<div class=\"section_title\">" );
+			/*std::string::size_type start = resp.data.find( "<div class=\"section_title\">" );
 			start = resp.data.find( "<div id=\"anchor_fbid_", start );
 			if ( start != std::string::npos ) {
 				start = resp.data.find( "\">", start );
@@ -906,19 +1045,46 @@
 				if ( end != std::string::npos ) {
 					if ( (BYTE)resp.data.at(end-1) == (BYTE)'.' ) end--; // This will hopefuly remove the "evil" dot ^^. ..Oh, no!. Stop!. Stop it!. .. Okay, you won :(               . (fuck, again!).
 					fbu->status = resp.data.substr( start, end - start );
+					fbu->status = utils::text::remove_html( fbu->status );
 					fbu->status = utils::text::special_expressions_decode( fbu->status ); }
 			}
 			else fbu->status = "";
 		}
-		{
-			std::string::size_type start = resp.data.find( "http://profile.ak.fbcdn.net" );
+		{*/
+
+		// statusy jsou zrusene ;)
+      fbu->status = "";			
+
+			std::string::size_type start;
+
+			if (DBGetContactSettingByte(NULL,parent->m_szModuleName,FACEBOOK_KEY_USE_HTTPS, 0)) {
+        start = resp.data.find( "url(https:\\/\\/fbcdn-profile-a.akamaihd.net" );
+			} else {
+				start = resp.data.find( "url(http:\\/\\/profile.ak.fbcdn.net" );
+			}
+      start += 4;
+
 			if ( start != std::string::npos ) {
-				std::string::size_type end = resp.data.find( "\"", start );
+				std::string::size_type end = resp.data.find( ")", start );
 				if ( end != std::string::npos ) {
-					fbu->image_url = resp.data.substr( start, end - start );
-			} } else
+          fbu->image_url = resp.data.substr( start, end - start );
+          fbu->image_url = utils::text::special_expressions_decode( fbu->image_url );
+				}
+			} else
 				fbu->image_url = FACEBOOK_DEFAULT_AVATAR_URL;
 		}
+/*		{ // v mobilni verzi se pamatuje vychozi jazyk z celeho fb :/
+// slo by ale zjistit nazev pole pro pohlavi muz/zena skrz http://m.facebook.com/editprofile.php?edit=gender&type=basic pi kadÔøΩm pÔøΩipojenÔøΩ, zapamatovat a pak porovnat s tÔøΩmto..
+			std::string::size_type start = resp.data.find( "<div class=\"mfsm\">" );
+			if ( start != std::string::npos ) {
+				std::string::size_type end = resp.data.find( "</div>", start );
+				if ( end != std::string::npos ) {
+					if ( resp.data.substr( start + 18, end - start ) == "Male" )
+						DBWriteContactSettingByte(fbu->handle,parent->m_szModuleName,"Gender",77);
+					else
+						DBWriteContactSettingByte(fbu->handle,parent->m_szModuleName,"Gender",70);
+			} }
+		}*/
 		// TODO: More items?
 	case HTTP_CODE_FOUND:
 		return handle_success( "get_profile" );
@@ -1000,3 +1166,19 @@
 	else
 		return false;
 }
+
+void facebook_client::close_chat( std::string message_recipient )
+{
+	if ( DBGetContactSettingByte(NULL, parent->m_szModuleName, FACEBOOK_KEY_CLOSE_CHAT_ENABLE, DEFAULT_CLOSE_CHAT_ENABLE ) != TRUE )
+		return ;
+
+	std::string data = "close_chat=";
+	data += message_recipient;
+	data += "&window_id=0";
+	data += "&post_form_id=";
+	data += ( post_form_id_.length( ) ) ? post_form_id_ : "0";
+	data += "&post_form_id_source=AsyncRequest";
+  data += "&fb_dtsg=" + this->dtsg_;
+	
+	http::response resp = flap( FACEBOOK_REQUEST_SETTINGS, &data );
+}
\ No newline at end of file
Index: connection.cpp
===================================================================
--- connection.cpp	(revision 88)
+++ connection.cpp	(working copy)
@@ -58,6 +58,11 @@
 	if ( NegotiateConnection( ) )
 	{
 		setDword( "LogonTS", (DWORD)time(NULL) );
+
+		// Oznamovat jen vƒõci, kter√© se objevily a≈æ po p≈ôihl√°≈°en√≠
+		if (!getByte(FACEBOOK_KEY_OLD_FEEDS_TIMESTAMP, 0))
+			this->facy.last_feeds_update_ = ::time( NULL );
+
 		m_hUpdLoop = ForkThreadEx( &FacebookProto::UpdateLoop,  this );
 		m_hMsgLoop = ForkThreadEx( &FacebookProto::MessageLoop, this );
 	}
@@ -75,7 +80,6 @@
 	KillThreads( );
 
 	deleteSetting( "LogonTS" );
-	SetAllContactStatuses( ID_STATUS_OFFLINE );
 
 	facy.logout( );
 	facy.clear_cookies( );
@@ -87,6 +91,8 @@
 	ProtoBroadcastAck(m_szModuleName,0,ACKTYPE_STATUS,ACKRESULT_SUCCESS,
 		(HANDLE)old_status,m_iStatus);
 
+	SetAllContactStatuses( ID_STATUS_OFFLINE );
+
 	ToggleStatusMenuItems(isOnline());
 
 	LOG("##### SignOff complete");
@@ -107,7 +113,7 @@
 	}
 	else
 	{
-		NotifyEvent(m_tszUserName,TranslateT("Please enter a username."));
+		NotifyEvent(m_tszUserName,TranslateT("Please enter a username."),0,FACEBOOK_EVENT_CLIENT);
 		goto error;
 	}
 
@@ -120,7 +126,7 @@
 	}
 	else
 	{
-		NotifyEvent(m_tszUserName,TranslateT("Please enter a password."));
+		NotifyEvent(m_tszUserName,TranslateT("Please enter a password."),0,FACEBOOK_EVENT_CLIENT);
 		goto error;
 	}
 
@@ -162,51 +168,52 @@
 
 void FacebookProto::UpdateLoop(void *)
 {
+	ScopedLock s(updateloop_lock_);
+
 	LOG( ">>>>> Entering Facebook::UpdateLoop" );
 
-	for ( DWORD i = 0; ; i++ )
+	int i = 0;
+	while (1)
 	{
-		if ( !isOnline( ) )
-			goto exit;
+		i = (i+1) % 48;  // ok, ok, tohle se mi moc nel√≠b√≠ ale po≈ô√°d je to lep≈°√≠ ne≈æ p≈ôiƒç√≠tat do p≈ôeteƒçen√≠ dwordu :D
+		if ( !isOnline( ) )	break;
 		if ( i != 0 )
 			if ( !facy.buddy_list( ) )
-				goto exit;
-		if ( !isOnline( ) )
-			goto exit;
+				break;
+		if ( !isOnline( ) )	break;
 		if ( i % 6 == 3 && getByte( FACEBOOK_KEY_FEEDS_ENABLE, DEFAULT_FEEDS_ENABLE ) )
 			if ( !facy.feeds( ) )
-				goto exit;
-		if ( !isOnline( ) )
-			goto exit;
+				break;
+		if ( !isOnline( ) ) break;
 		if ( i % 8 == 7 )
-			if ( !facy.keep_alive( ) )
-				goto exit;
-		if ( !isOnline( ) )
-			goto exit;
+//			if ( !facy.idle_ ) // 1) zrejme nefunguje ten hook na onidlechange 2) i tak je keep_alive potreba i pri necinnosti 3) takze delat jinak/jinde
+				if ( !facy.keep_alive( ) )
+					break;
+		if ( !isOnline( ) )	break;
 		LOG( "***** FacebookProto::UpdateLoop going to sleep..." );
 		if ( SleepEx( GetPollRate( ) * 1000, true ) == WAIT_IO_COMPLETION )
-			goto exit;
+			break;
 		LOG( "***** FacebookProto::UpdateLoop waking up..." );
 	}
 
-exit:
 	LOG( "<<<<< Exiting FacebookProto::UpdateLoop" );
 }
 
 void FacebookProto::MessageLoop(void *)
 {
+	ScopedLock s(messageloop_lock_); // ne moc funkcni, spis nefunkcni...
+	
 	LOG( ">>>>> Entering Facebook::MessageLoop" );
 
-	for ( DWORD i = 0; ; i++ )
+	while (1)
 	{
 		if ( !isOnline( ) )
-			goto exit;
+			break;
 		if ( !facy.channel( ) )
-			goto exit;
+			break;
 		LOG( "***** FacebookProto::MessageLoop refreshing..." );
 	}
 
-exit:
 	LOG( "<<<<< Exiting FacebookProto::MessageLoop" );
 }
 
Index: constants.h
===================================================================
--- constants.h	(revision 88)
+++ constants.h	(working copy)
@@ -3,7 +3,7 @@
 Facebook plugin for Miranda Instant Messenger
 _____________________________________________
 
-Copyright ¬© 2009-10 Michal Zelinka
+Copyright ÔøΩ 2009-10 Michal Zelinka
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
@@ -52,7 +52,6 @@
 // Product management
 #define FACEBOOK_NAME               "Facebook"
 #define FACEBOOK_URL_HOMEPAGE       "http://www.facebook.com/"
-#define PLUGIN_HOSTING_URL          "http://code.google.com/p/eternityplugins/"
 
 // Connection
 #define FACEBOOK_SERVER_REGULAR     "www.facebook.com"
@@ -60,7 +59,11 @@
 #define FACEBOOK_SERVER_CHAT        "%s.%s.facebook.com"
 #define FACEBOOK_SERVER_LOGIN       "login.facebook.com"
 #define FACEBOOK_SERVER_APPS        "apps.facebook.com"
+#define PLUGIN_HOSTING_URL          "http://code.google.com/p/eternityplugins/"
 
+#define FACEBOOK_URL_REQUESTS		"http://www.facebook.com/reqs.php"
+#define FACEBOOK_URL_MESSAGES		"http://www.facebook.com/?sk=messages"
+
 // Limits
 #define FACEBOOK_MESSAGE_LIMIT      1024
 #define FACEBOOK_MESSAGE_LIMIT_TEXT "1024"
@@ -78,6 +81,10 @@
 
 #define DEFAULT_NOTIFICATIONS_ENABLE    1
 #define DEFAULT_FEEDS_ENABLE            1
+#define DEFAULT_CLIENT_ENABLE           1
+#define DEFAULT_OTHER_ENABLE            1
+#define DEFAULT_CLOSE_CHAT_ENABLE		0
+
 #define DEFAULT_EVENTS_COLBACK          0x00ffffff
 #define DEFAULT_EVENTS_COLTEXT          0x00000000
 #define DEFAULT_EVENTS_TIMEOUT_TYPE     0
@@ -99,13 +106,20 @@
 #define FACEBOOK_REQUEST_STATUS_SET             251 // setting my "What's on my mind?"
 #define FACEBOOK_REQUEST_MESSAGE_SEND           300 // sending message
 #define FACEBOOK_REQUEST_MESSAGES_RECEIVE       301 // receiving messages
-#define FACEBOOK_REQUEST_TYPING_SEND            304 // typing notification
-#define FACEBOOK_REQUEST_CHAT_WINDOW_CLOSE      305 // closing message window
+#define FACEBOOK_REQUEST_TYPING					304 // typing notification
+#define FACEBOOK_REQUEST_SETTINGS				305 // some settings (close chat, set chat visibility,...)
 
 // Reconnect flags
-#define FACEBOOK_RECONNECT_LOGIN        "6" // When logging in
-#define FACEBOOK_RECONNECT_KEEP_ALIVE   "0" // After a period, used to keep session alive
+#define FACEBOOK_RECONNECT_LOGIN        "6" // When logging in - jarvis m√° 6, ale m√°m dojem ≈æe to m√° b√Ωt 5
+#define FACEBOOK_RECONNECT_KEEP_ALIVE   "0" // After a period, used to keep session alive - jarvis m√° 0, ale mysl√≠m ≈æe m√° b√Ωt 6
+											// nev√≠m jak zjistit co je spr√°vnƒõ :D
 
+// Events flags
+#define FACEBOOK_EVENT_CLIENT			500 // facebook error or info message
+#define FACEBOOK_EVENT_NEWSFEED			510 // facebook newsfeed (wall) message
+#define FACEBOOK_EVENT_NOTIFICATION		520 // facebook new notification
+#define FACEBOOK_EVENT_OTHER			530 // facebook other event - friend requests/new messages
+
 // User-Agents
 static const char* user_agents[] = {
 	"Miranda IM (default)",
Index: contacts.cpp
===================================================================
--- contacts.cpp	(revision 88)
+++ contacts.cpp	(working copy)
@@ -77,6 +77,7 @@
 		if(CallService(MS_PROTO_ADDTOCONTACT,(WPARAM)hContact,(LPARAM)m_szModuleName) == 0)
 		{
 			DBWriteContactSettingString(hContact,m_szModuleName,FACEBOOK_KEY_ID,fbu->user_id.c_str());
+			DBDeleteContactSetting(hContact, "CList", "MyHandle");
 			DBVARIANT dbv;
 			if( !DBGetContactSettingTString(NULL,m_szModuleName,FACEBOOK_KEY_DEF_GROUP,&dbv) )
 			{
@@ -142,6 +143,15 @@
 
 			if (!fbu->last_update) // just come online
 				DBWriteContactSettingWord(fbu->handle,m_szModuleName,"Status",ID_STATUS_ONLINE );
+
+			// Update idle flag
+			if ( fbu->is_idle ) {
+				if ( !DBGetContactSettingDword(fbu->handle,m_szModuleName,"IdleTS",0) )
+					DBWriteContactSettingDword(fbu->handle,m_szModuleName,"IdleTS",(DWORD)time(NULL)); }
+			else {
+				if ( DBGetContactSettingDword(fbu->handle,m_szModuleName,"IdleTS",0) )
+					DBWriteContactSettingDword(fbu->handle,m_szModuleName,"IdleTS",0); }
+
 		}
 
 		if ( fbu->user_id == facy.self_.user_id || ContactNeedsUpdate( fbu ) )
@@ -160,15 +170,6 @@
 				DBWriteContactSettingUTF8String(fbu->handle,m_szModuleName,FACEBOOK_KEY_NAME,fbu->real_name.c_str());
 				DBWriteContactSettingUTF8String(fbu->handle,m_szModuleName,"Nick",fbu->real_name.c_str()); }
 
-			// Update idle flag
-
-			if ( fbu->is_idle ) {
-				if ( !DBGetContactSettingDword(fbu->handle,m_szModuleName,"IdleTS",0) )
-					DBWriteContactSettingDword(fbu->handle,m_szModuleName,"IdleTS",(DWORD)time(NULL)); }
-			else {
-				if ( DBGetContactSettingDword(fbu->handle,m_szModuleName,"IdleTS",0) )
-					DBWriteContactSettingDword(fbu->handle,m_szModuleName,"IdleTS",0); }
-
 			// Get Status message and Avatar URL if needed
 
 			facy.get_profile( fbu );
@@ -193,6 +194,8 @@
 
 			if ( !DBGetContactSettingString(fbu->handle,m_szModuleName,FACEBOOK_KEY_AV_URL,&dbv) ) {
 				update_required = strcmp( dbv.pszVal, fbu->image_url.c_str() ) != 0;
+				if (!update_required)
+					update_required = AvatarExists(fbu);
 				DBFreeVariant(&dbv); }
 			else update_required = true;
 
Index: db.h
===================================================================
--- db.h	(revision 88)
+++ db.h	(working copy)
@@ -52,16 +52,39 @@
 #define FACEBOOK_KEY_AV_URL         "AvatarURL"
 #define FACEBOOK_KEY_POLL_RATE      "PollRate"
 #define FACEBOOK_KEY_USER_AGENT     "UserAgent"
-#define FACEBOOK_KEY_FORCE_HTTPS    "ForceHTTPS"
+#define FACEBOOK_KEY_LOGGING_ENABLE "LoggingEnable"
+#define FACEBOOK_KEY_CLOSE_CHAT_ENABLE "CloseChatEnable"
 #define FACEBOOK_KEY_SET_MIRANDA_STATUS "SetMirandaStatus"
-#define FACEBOOK_KEY_LOGGING_ENABLE "LoggingEnable"
+#define FACEBOOK_KEY_USE_HTTPS      "UseHTTPS"
 #define FACEBOOK_KEY_TIMEOUTS_LIMIT "TimeoutsLimit" // [HIDDEN]
 #define FACEBOOK_KEY_DISABLE_LOGOUT "DisableLogout" // [HIDDEN]
 #define FACEBOOK_KEY_DISABLE_STATUS_NOTIFY  "DisableStatusNotify" // [HIDDEN]
+#define FACEBOOK_KEY_OLD_FEEDS_TIMESTAMP  "OldFeedsTimestamp" // [HIDDEN]
+#define FACEBOOK_KEY_IGNORE_CHANNEL_TIMEOUTS  "IgnoreChannelTimeouts" // [HIDDEN]
 
-#define FACEBOOK_KEY_NOTIFICATIONS_ENABLE   "NotificationsEnable"
-#define FACEBOOK_KEY_FEEDS_ENABLE           "FeedsEnable"
-#define FACEBOOK_KEY_EVENTS_COLBACK         "EventsColorBack"
-#define FACEBOOK_KEY_EVENTS_COLTEXT         "EventsColorText"
-#define FACEBOOK_KEY_EVENTS_TIMEOUT_TYPE    "EventsTimeoutType"
-#define FACEBOOK_KEY_EVENTS_TIMEOUT         "EventsTimeout"
+#define FACEBOOK_KEY_SYSTRAY_NOTIFY "UseSystrayNotify"
+
+#define FACEBOOK_KEY_NOTIFICATIONS_ENABLE   "PopupNotificationsEnable"
+#define FACEBOOK_KEY_FEEDS_ENABLE           "PopupFeedsEnable"
+#define FACEBOOK_KEY_CLIENT_ENABLE           "PopupClientEnable"
+#define FACEBOOK_KEY_OTHER_ENABLE           "PopupOtherEnable"
+
+#define FACEBOOK_KEY_EVENTS_NOTIFICATIONS_COLBACK		"PopupNotificationsColorBack"
+#define FACEBOOK_KEY_EVENTS_NOTIFICATIONS_COLTEXT       "PopupNotificationsColorText"
+#define FACEBOOK_KEY_EVENTS_NOTIFICATIONS_TIMEOUT       "PopupNotificationsTimeout"
+#define FACEBOOK_KEY_EVENTS_NOTIFICATIONS_DEFAULT       "PopupNotificationsColorDefault"
+
+#define FACEBOOK_KEY_EVENTS_FEEDS_COLBACK				"PopupFeedsColorBack"
+#define FACEBOOK_KEY_EVENTS_FEEDS_COLTEXT				"PopupFeedsColorText"
+#define FACEBOOK_KEY_EVENTS_FEEDS_TIMEOUT				"PopupFeedsTimeout"
+#define FACEBOOK_KEY_EVENTS_FEEDS_DEFAULT				"PopupFeedsColorDefault"
+
+#define FACEBOOK_KEY_EVENTS_CLIENT_COLBACK				"PopupClientColorBack"
+#define FACEBOOK_KEY_EVENTS_CLIENT_COLTEXT				"PopupClientColorText"
+#define FACEBOOK_KEY_EVENTS_CLIENT_TIMEOUT				"PopupClientTimeout"
+#define FACEBOOK_KEY_EVENTS_CLIENT_DEFAULT				"PopupClientColorDefault"
+
+#define FACEBOOK_KEY_EVENTS_OTHER_COLBACK				"PopupOtherColorBack"
+#define FACEBOOK_KEY_EVENTS_OTHER_COLTEXT				"PopupOtherColorText"
+#define FACEBOOK_KEY_EVENTS_OTHER_TIMEOUT				"PopupOtherTimeout"
+#define FACEBOOK_KEY_EVENTS_OTHER_DEFAULT				"PopupOtherColorDefault"
Index: dialogs.cpp
===================================================================
--- dialogs.cpp	(revision 88)
+++ dialogs.cpp	(working copy)
@@ -3,7 +3,7 @@
 Facebook plugin for Miranda Instant Messenger
 _____________________________________________
 
-Copyright ¬© 2009-10 Michal Zelinka
+Copyright ? 2009-10 Michal Zelinka
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
@@ -156,9 +156,11 @@
 			_sntprintf( str, 4, TEXT( "%d" ), FACEBOOK_MIND_LIMIT-len );
 			SetDlgItemText(hwnd,IDC_CHARACTERS,str);
 
-			SetDlgItemText(hwnd,IDOK, (len > 0) ? TranslateT("Share") : TranslateT("Clear"));
-			EnableWindow(GetDlgItem( hwnd, IDOK ), TRUE);
+			/*SetDlgItemText(hwnd,IDOK, (len > 0) ? TranslateT("Share") : TranslateT("Clear"));
+			EnableWindow(GetDlgItem( hwnd, IDOK ), TRUE);*/
 
+			  EnableWindow(GetDlgItem( hwnd, IDOK ), len > 0);
+
 			return TRUE;
 		}
 		else if ( LOWORD( wparam ) == IDOK )
@@ -235,9 +237,9 @@
 		SendDlgItemMessage(hwnd, IDC_AGENT, CB_SETCURSEL,
 		    DBGetContactSettingByte(NULL, proto->m_szModuleName, "UserAgent", 0), 0);
 
-		LoadDBCheckState(proto, hwnd, IDC_SECURE, FACEBOOK_KEY_FORCE_HTTPS, 0);
-		LoadDBCheckState(proto, hwnd, IDC_SET_STATUS, FACEBOOK_KEY_SET_MIRANDA_STATUS, 0);
 		LoadDBCheckState(proto, hwnd, IDC_LOGGING, FACEBOOK_KEY_LOGGING_ENABLE, 0);
+		LoadDBCheckState(proto, hwnd, IDC_USE_HTTPS, FACEBOOK_KEY_USE_HTTPS, 0);
+		LoadDBCheckState(proto, hwnd, IDC_CLOSE_CHAT, FACEBOOK_KEY_CLOSE_CHAT_ENABLE, 0);
 
 		} return TRUE;
 
@@ -295,9 +297,9 @@
 			DBWriteContactSettingByte(NULL, proto->m_szModuleName, "UserAgent",
 			    SendDlgItemMessage(hwnd, IDC_AGENT, CB_GETCURSEL, 0, 0));
 
-			StoreDBCheckState(proto, hwnd, IDC_SECURE, FACEBOOK_KEY_FORCE_HTTPS);
-			StoreDBCheckState(proto, hwnd, IDC_SET_STATUS, FACEBOOK_KEY_SET_MIRANDA_STATUS);
 			StoreDBCheckState(proto, hwnd, IDC_LOGGING, FACEBOOK_KEY_LOGGING_ENABLE);
+			StoreDBCheckState(proto, hwnd, IDC_USE_HTTPS, FACEBOOK_KEY_USE_HTTPS);
+			StoreDBCheckState(proto, hwnd, IDC_CLOSE_CHAT, FACEBOOK_KEY_CLOSE_CHAT_ENABLE);
 
 			return TRUE;
 		}
@@ -321,8 +323,44 @@
 		proto = reinterpret_cast<FacebookProto*>(lparam);
 		SetWindowLong(hwnd,GWL_USERDATA,lparam);
 
+		// RM TODO: rewrite to functions
+		
+		SendDlgItemMessage(hwnd, IDC_TIMEOUT, EM_LIMITTEXT, 4, 0);
+		SendDlgItemMessage(hwnd, IDC_TIMEOUT_SPIN, UDM_SETRANGE32, -1, 100);
+		SendDlgItemMessage(hwnd, IDC_TIMEOUT2, EM_LIMITTEXT, 4, 0);
+		SendDlgItemMessage(hwnd, IDC_TIMEOUT_SPIN2, UDM_SETRANGE32, -1, 100);
+		SendDlgItemMessage(hwnd, IDC_TIMEOUT3, EM_LIMITTEXT, 4, 0);
+		SendDlgItemMessage(hwnd, IDC_TIMEOUT_SPIN3, UDM_SETRANGE32, -1, 100);
+		SendDlgItemMessage(hwnd, IDC_TIMEOUT4, EM_LIMITTEXT, 4, 0);
+		SendDlgItemMessage(hwnd, IDC_TIMEOUT_SPIN4, UDM_SETRANGE32, -1, 100);
+
+		LoadDBCheckState(proto, hwnd, IDC_SYSTRAY_NOTIFY, FACEBOOK_KEY_SYSTRAY_NOTIFY, 0);
 		LoadDBCheckState(proto, hwnd, IDC_NOTIFICATIONS_ENABLE, FACEBOOK_KEY_NOTIFICATIONS_ENABLE, DEFAULT_NOTIFICATIONS_ENABLE);
 		LoadDBCheckState(proto, hwnd, IDC_FEEDS_ENABLE, FACEBOOK_KEY_FEEDS_ENABLE, DEFAULT_FEEDS_ENABLE);
+		LoadDBCheckState(proto, hwnd, IDC_CLIENT_ENABLE, FACEBOOK_KEY_CLIENT_ENABLE, DEFAULT_CLIENT_ENABLE);
+		LoadDBCheckState(proto, hwnd, IDC_OTHER_ENABLE, FACEBOOK_KEY_OTHER_ENABLE, DEFAULT_OTHER_ENABLE);
+
+		LoadDBCheckState(proto, hwnd, IDC_NOTIFICATIONS_DEFAULT, FACEBOOK_KEY_EVENTS_NOTIFICATIONS_DEFAULT, 0);
+		LoadDBCheckState(proto, hwnd, IDC_FEEDS_DEFAULT, FACEBOOK_KEY_EVENTS_FEEDS_DEFAULT, 0);
+		LoadDBCheckState(proto, hwnd, IDC_CLIENT_DEFAULT, FACEBOOK_KEY_EVENTS_CLIENT_DEFAULT, 0);
+		LoadDBCheckState(proto, hwnd, IDC_OTHER_DEFAULT, FACEBOOK_KEY_EVENTS_OTHER_DEFAULT, 0);
+
+		SendDlgItemMessage(hwnd, IDC_COLBACK, CPM_SETCOLOUR, 0, DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_NOTIFICATIONS_COLBACK,DEFAULT_EVENTS_COLBACK));
+		SendDlgItemMessage(hwnd, IDC_COLTEXT, CPM_SETCOLOUR, 0, DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_NOTIFICATIONS_COLTEXT,DEFAULT_EVENTS_COLTEXT));
+		SetDlgItemInt(hwnd, IDC_TIMEOUT,DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_NOTIFICATIONS_TIMEOUT, 0),TRUE);
+
+		SendDlgItemMessage(hwnd, IDC_COLBACK2, CPM_SETCOLOUR, 0, DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_FEEDS_COLBACK,DEFAULT_EVENTS_COLBACK));
+		SendDlgItemMessage(hwnd, IDC_COLTEXT2, CPM_SETCOLOUR, 0, DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_FEEDS_COLTEXT,DEFAULT_EVENTS_COLTEXT));
+		SetDlgItemInt(hwnd, IDC_TIMEOUT2,DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_FEEDS_TIMEOUT, 0),TRUE);
+
+		SendDlgItemMessage(hwnd, IDC_COLBACK3, CPM_SETCOLOUR, 0, DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_OTHER_COLBACK,DEFAULT_EVENTS_COLBACK));
+		SendDlgItemMessage(hwnd, IDC_COLTEXT3, CPM_SETCOLOUR, 0, DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_OTHER_COLTEXT,DEFAULT_EVENTS_COLTEXT));
+		SetDlgItemInt(hwnd, IDC_TIMEOUT3,DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_OTHER_TIMEOUT, 0),TRUE);
+
+		SendDlgItemMessage(hwnd, IDC_COLBACK4, CPM_SETCOLOUR, 0, DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_CLIENT_COLBACK,DEFAULT_EVENTS_COLBACK));
+		SendDlgItemMessage(hwnd, IDC_COLTEXT4, CPM_SETCOLOUR, 0, DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_CLIENT_COLTEXT,DEFAULT_EVENTS_COLTEXT));
+		SetDlgItemInt(hwnd, IDC_TIMEOUT4,DBGetContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_CLIENT_TIMEOUT, 0),TRUE);
+
 	} return TRUE;
 
 	case WM_COMMAND: {
@@ -331,23 +369,61 @@
 		case IDC_PREVIEW: {
 			TCHAR protoName[255];
 			lstrcpy( protoName, proto->m_tszUserName );
-			proto->NotifyEvent( protoName, TranslateT("Sample event") ); }
+			
+			proto->NotifyEvent( protoName, TranslateT("Sample event"), 0, FACEBOOK_EVENT_CLIENT ); 
+			proto->NotifyEvent( protoName, TranslateT("Sample request"), 0, FACEBOOK_EVENT_OTHER ); 
+			proto->NotifyEvent( protoName, TranslateT("Sample newsfeed"), 0, FACEBOOK_EVENT_NEWSFEED ); 
+			proto->NotifyEvent( protoName, TranslateT("Sample notification"), 0, FACEBOOK_EVENT_NOTIFICATION ); 
+						
+			}
 			break;
-
+		case IDC_COLTEXT: case IDC_COLBACK: case IDC_COLTEXT2: case IDC_COLBACK2: case IDC_COLTEXT3: case IDC_COLBACK3: case IDC_COLTEXT4: case IDC_COLBACK4:
+			SendMessage(GetParent(hwnd),PSM_CHANGED,0,0);
 		}
 
 		if ((LOWORD(wparam)==IDC_PREVIEW || (HWND)lparam!=GetFocus()))
 			return 0;
 		else
-			SendMessage(GetParent(hwnd),PSM_CHANGED,0,0); }
+			SendMessage(GetParent(hwnd),PSM_CHANGED,0,0);
+
 		return TRUE;
-
+		}
 	case WM_NOTIFY: {
 		if ( reinterpret_cast<NMHDR*>(lparam)->code == PSN_APPLY )
 		{
+			StoreDBCheckState(proto, hwnd, IDC_SYSTRAY_NOTIFY, FACEBOOK_KEY_SYSTRAY_NOTIFY);
+			
 			StoreDBCheckState(proto, hwnd, IDC_NOTIFICATIONS_ENABLE, FACEBOOK_KEY_NOTIFICATIONS_ENABLE);
 			StoreDBCheckState(proto, hwnd, IDC_FEEDS_ENABLE, FACEBOOK_KEY_FEEDS_ENABLE);
-		} }
+			StoreDBCheckState(proto, hwnd, IDC_CLIENT_ENABLE, FACEBOOK_KEY_CLIENT_ENABLE);
+			StoreDBCheckState(proto, hwnd, IDC_OTHER_ENABLE, FACEBOOK_KEY_OTHER_ENABLE);
+
+			StoreDBCheckState(proto, hwnd, IDC_NOTIFICATIONS_DEFAULT, FACEBOOK_KEY_EVENTS_NOTIFICATIONS_DEFAULT);
+			StoreDBCheckState(proto, hwnd, IDC_FEEDS_DEFAULT, FACEBOOK_KEY_EVENTS_FEEDS_DEFAULT);
+			StoreDBCheckState(proto, hwnd, IDC_CLIENT_DEFAULT, FACEBOOK_KEY_EVENTS_CLIENT_DEFAULT);
+			StoreDBCheckState(proto, hwnd, IDC_OTHER_DEFAULT, FACEBOOK_KEY_EVENTS_OTHER_DEFAULT);
+
+			// RM TODO: rewrite to functions
+
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_NOTIFICATIONS_COLBACK, SendDlgItemMessage(hwnd,IDC_COLBACK,CPM_GETCOLOUR,0,0));
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_NOTIFICATIONS_COLTEXT, SendDlgItemMessage(hwnd,IDC_COLTEXT,CPM_GETCOLOUR,0,0));
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_NOTIFICATIONS_TIMEOUT, GetDlgItemInt(hwnd,IDC_TIMEOUT,NULL,TRUE));
+			
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_FEEDS_COLBACK, SendDlgItemMessage(hwnd,IDC_COLBACK2,CPM_GETCOLOUR,0,0));
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_FEEDS_COLTEXT, SendDlgItemMessage(hwnd,IDC_COLTEXT2,CPM_GETCOLOUR,0,0));
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_FEEDS_TIMEOUT, GetDlgItemInt(hwnd,IDC_TIMEOUT2,NULL,TRUE));
+
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_OTHER_COLBACK, SendDlgItemMessage(hwnd,IDC_COLBACK3,CPM_GETCOLOUR,0,0));
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_OTHER_COLTEXT, SendDlgItemMessage(hwnd,IDC_COLTEXT3,CPM_GETCOLOUR,0,0));
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_OTHER_TIMEOUT, GetDlgItemInt(hwnd,IDC_TIMEOUT3,NULL,TRUE));
+
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_CLIENT_COLBACK, SendDlgItemMessage(hwnd,IDC_COLBACK4,CPM_GETCOLOUR,0,0));
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_CLIENT_COLTEXT, SendDlgItemMessage(hwnd,IDC_COLTEXT4,CPM_GETCOLOUR,0,0));
+			DBWriteContactSettingDword(NULL, proto->m_szModuleName, FACEBOOK_KEY_EVENTS_CLIENT_TIMEOUT, GetDlgItemInt(hwnd,IDC_TIMEOUT4,NULL,TRUE));
+			break;
+		} 
+				
+	}
 		return TRUE;
 
 	}
Index: entities.h
===================================================================
--- entities.h	(revision 88)
+++ entities.h	(working copy)
@@ -88,10 +88,10 @@
 {
 	std::string user_id;
 	std::string text;
-	std::string link;
+	std::string url;
 
 	facebook_notification( ) {
-		this->user_id = this->text = this->link = ""; }
+		this->user_id = this->text = this->url = ""; }
 };
 
 struct facebook_newsfeed
@@ -99,8 +99,8 @@
 	std::string user_id;
 	std::string title;
 	std::string text;
-	std::string link;
+	std::string url;
 
 	facebook_newsfeed( ) {
-		this->user_id = this->title = this->text = this->link = ""; }
+		this->user_id = this->title = this->text = this->url = ""; }
 };
Index: events.cpp
===================================================================
--- events.cpp	(revision 88)
+++ events.cpp	(working copy)
@@ -3,7 +3,7 @@
 Facebook plugin for Miranda Instant Messenger
 _____________________________________________
 
-Copyright © 2009-10 Michal Zelinka
+Copyright ÔøΩ 2009-10 Michal Zelinka
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
@@ -49,26 +49,99 @@
 	return utils::debug::log( m_szModuleName, text );
 }
 
-int FacebookProto::NotifyEvent(TCHAR* title, TCHAR* info, HANDLE contact, DWORD flags)
+LRESULT CALLBACK PopupDlgProc(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam) {
+	switch(message) 
+		{
+		case WM_COMMAND: 
+			{
+			//Get the plugin data (we need the PopUp service to do it)
+			TCHAR* data = (TCHAR*)PUGetPluginData(hwnd);
+			if (data != 0) {
+//				char *url = mir_t2a_cp(data,CP_UTF8);
+				std::string url2 = mir_t2a_cp(data,CP_UTF8);
+				std::string url = "http://www.facebook.com";
+				if ( url2.substr(0,4) != "http" ) {
+					url.append(url2);
+					CallService(MS_UTILS_OPENURL, (WPARAM) 1, (LPARAM) url.c_str() );
+				} else {
+					CallService(MS_UTILS_OPENURL, (WPARAM) 1, (LPARAM) url2.c_str() );
+				}
+			}
+
+			// After a click, destroy popup
+			PUDeletePopUp(hwnd);
+			break; 
+			}
+		case WM_CONTEXTMENU: 
+			{
+			PUDeletePopUp(hwnd);
+			break;
+			}
+		case UM_FREEPLUGINDATA: {
+			// After close, free
+			TCHAR* url = (TCHAR*)PUGetPluginData(hwnd);
+			if (url != 0) {
+				mir_free(url);
+			}
+			return FALSE;//break;
+		}
+		default:
+			break; 
+	}
+	return DefWindowProc(hwnd, message, wParam, lParam);
+};
+
+
+int FacebookProto::NotifyEvent(TCHAR* title, TCHAR* info, HANDLE contact, DWORD flags, TCHAR* url)
 {
-	int ret; BYTE timeout;
+	int ret; int timeout; COLORREF colorBack = 0; COLORREF colorText = 0;
 
-	SkinPlaySound( "NewNotification" );
+	switch ( flags ) {
+		case FACEBOOK_EVENT_CLIENT:
+			if ( getByte( FACEBOOK_KEY_EVENTS_CLIENT_DEFAULT, 0 ) != TRUE ) {
+				colorBack = getDword( FACEBOOK_KEY_EVENTS_CLIENT_COLBACK, DEFAULT_EVENTS_COLBACK );
+				colorText = getDword( FACEBOOK_KEY_EVENTS_CLIENT_COLTEXT, DEFAULT_EVENTS_COLTEXT );
+			}
+			timeout = getDword( FACEBOOK_KEY_EVENTS_CLIENT_TIMEOUT, 0 );
+			break;
+		case FACEBOOK_EVENT_NEWSFEED:
+			if ( getByte( FACEBOOK_KEY_EVENTS_FEEDS_DEFAULT, 0 ) != TRUE ) {
+				colorBack = getDword( FACEBOOK_KEY_EVENTS_FEEDS_COLBACK, DEFAULT_EVENTS_COLBACK );
+				colorText = getDword( FACEBOOK_KEY_EVENTS_FEEDS_COLTEXT, DEFAULT_EVENTS_COLTEXT );
+			}
+			timeout = getDword( FACEBOOK_KEY_EVENTS_FEEDS_TIMEOUT, 0 );
+			SkinPlaySound( "NewsFeed" );
+			break;
+		case FACEBOOK_EVENT_NOTIFICATION:
+			if ( getByte( FACEBOOK_KEY_EVENTS_NOTIFICATIONS_DEFAULT, 0 ) != TRUE ) {
+				colorBack = getDword( FACEBOOK_KEY_EVENTS_NOTIFICATIONS_COLBACK, DEFAULT_EVENTS_COLBACK );
+				colorText = getDword( FACEBOOK_KEY_EVENTS_NOTIFICATIONS_COLTEXT, DEFAULT_EVENTS_COLTEXT );
+			}
+			timeout = getDword( FACEBOOK_KEY_EVENTS_NOTIFICATIONS_TIMEOUT, 0 );
+			SkinPlaySound( "NewNotification" );
+			break;
+		case FACEBOOK_EVENT_OTHER:
+			if ( getByte( FACEBOOK_KEY_EVENTS_OTHER_DEFAULT, 0 ) != TRUE ) {
+				colorBack = getDword( FACEBOOK_KEY_EVENTS_OTHER_COLBACK, DEFAULT_EVENTS_COLBACK );
+				colorText = getDword( FACEBOOK_KEY_EVENTS_OTHER_COLTEXT, DEFAULT_EVENTS_COLTEXT );
+			}
+			timeout = getDword( FACEBOOK_KEY_EVENTS_OTHER_TIMEOUT, 0 );
+			SkinPlaySound( "OtherEvent" );
+			break;
+	}
 
-	switch ( getByte( FACEBOOK_KEY_EVENTS_TIMEOUT_TYPE, DEFAULT_EVENTS_TIMEOUT_TYPE ) ) {
-		case 0: default: timeout = 0; break;
-		case 1: timeout = getByte( FACEBOOK_KEY_EVENTS_TIMEOUT, DEFAULT_EVENTS_TIMEOUT ); break;
-		case 2: timeout = -1; }
 
+if ( getByte(FACEBOOK_KEY_SYSTRAY_NOTIFY,0) != TRUE ) {
+
 	if (ServiceExists(MS_POPUP_ADDPOPUP)) {
 		POPUPDATAT pd;
-		pd.colorBack = getByte( FACEBOOK_KEY_EVENTS_COLBACK, DEFAULT_EVENTS_COLBACK );
-		pd.colorText = getByte( FACEBOOK_KEY_EVENTS_COLTEXT, DEFAULT_EVENTS_COLTEXT );
+		pd.colorBack = colorBack;
+		pd.colorText = colorText; 
 		pd.iSeconds = timeout;
 		pd.lchContact = contact;
-		pd.lchIcon = GetIcon(1); // TODO: Icon test
-		pd.PluginData = NULL;
-		pd.PluginWindowProc = NULL;
+ 		pd.lchIcon = GetIcon(1); // TODO: Icon test
+		pd.PluginData = url;
+		pd.PluginWindowProc = (WNDPROC)PopupDlgProc;
 		lstrcpy(pd.lptzContactName, title);
 		lstrcpy(pd.lptzText, info);
 		ret = PUAddPopUpT(&pd);
@@ -77,11 +150,13 @@
 			return 1;
 	}
 
+} else {
+
 	if (ServiceExists(MS_CLIST_SYSTRAY_NOTIFY)) {
 		MIRANDASYSTRAYNOTIFY err;
 		err.szProto = m_szModuleName;
 		err.cbSize = sizeof(err);
-		err.dwInfoFlags = NIIF_INTERN_TCHAR | flags;
+		err.dwInfoFlags = NIIF_INTERN_TCHAR;
 		err.tszInfoTitle = title;
 		err.tszInfo = info;
 		err.uTimeout = 1000 * timeout;
@@ -91,6 +166,10 @@
 			return 1;
 	} 
 
-//	MessageBox(NULL, info, title, MB_OK | MB_ICONINFORMATION);
+}	
+
+	if (flags == FACEBOOK_EVENT_CLIENT) 
+		MessageBox(NULL, info, title, MB_OK | MB_ICONINFORMATION);
+
 	return 0;
 }
Index: facebook.rc
===================================================================
--- facebook.rc	(revision 88)
+++ facebook.rc	(working copy)
@@ -40,7 +40,7 @@
 
 3 TEXTINCLUDE 
 BEGIN
-    "\r\n"
+    "\r\0"
 END
 
 #endif    // APSTUDIO_INVOKED
@@ -86,7 +86,7 @@
     PUSHBUTTON      "Cancel",IDCANCEL,159,44,50,14
 END
 
-IDD_OPTIONS DIALOGEX 0, 0, 305, 227
+IDD_OPTIONS DIALOGEX 0, 0, 305, 233
 STYLE DS_SETFONT | DS_FIXEDSYS | WS_CHILD
 EXSTYLE WS_EX_CONTROLPARENT
 FONT 8, "MS Shell Dlg", 400, 0, 0x1
@@ -98,17 +98,19 @@
     EDITTEXT        IDC_PW,106,39,142,13,ES_PASSWORD | ES_AUTOHSCROLL
     CONTROL         "Create a new Facebook account",IDC_NEWACCOUNTLINK,
                     "Hyperlink",WS_TABSTOP,106,57,142,12
-    GROUPBOX        "Advanced Settings",IDC_STATIC,51,79,204,141,WS_DISABLED
+    GROUPBOX        "Advanced Settings",IDC_STATIC,51,84,204,142,WS_DISABLED
     LTEXT           "Default group for newly added contacts:",IDC_STATIC,59,95,189,8
     EDITTEXT        IDC_GROUP,106,106,142,13,ES_AUTOHSCROLL
-    LTEXT           "User-Agent:",IDC_STATIC,59,128,44,8
-    COMBOBOX        IDC_AGENT,106,126,142,59,CBS_DROPDOWNLIST | WS_VSCROLL | WS_TABSTOP
-    CONTROL         "Force secure (HTTPS) connection",IDC_SECURE,"Button",BS_AUTOCHECKBOX | WS_TABSTOP,59,147,189,10
+    LTEXT           "User-Agent:",IDC_STATIC,59,127,44,8
+    COMBOBOX        IDC_AGENT,106,125,142,59,CBS_DROPDOWNLIST | WS_VSCROLL | WS_TABSTOP
     CONTROL         "Set Facebook ""What's on my mind"" status through Miranda status",IDC_SET_STATUS,
-                    "Button",BS_AUTOCHECKBOX | BS_TOP | BS_MULTILINE | WS_TABSTOP,59,161,189,18
+                    "Button",BS_AUTOCHECKBOX | BS_TOP | BS_MULTILINE | WS_TABSTOP,59,157,189,18
     CONTROL         "Enable logging for debugging purposes",IDC_LOGGING,
-                    "Button",BS_AUTOCHECKBOX | WS_TABSTOP,59,182,189,10
-    PUSHBUTTON      "Show cookies",IDC_COOKIES,87,198,131,14
+                    "Button",BS_AUTOCHECKBOX | WS_TABSTOP,59,176,189,10
+    PUSHBUTTON      "Show cookies",IDC_COOKIES,87,204,131,14
+    CONTROL         "Automatically close chat windows (on website)",IDC_CLOSE_CHAT,
+                    "Button",BS_AUTOCHECKBOX | WS_TABSTOP,59,191,189,10
+    CONTROL         "Use a secure connection (HTTPS)",IDC_USE_HTTPS,"Button",BS_AUTOCHECKBOX | WS_TABSTOP,59,143,189,10
 END
 
 IDD_OPTIONS_EVENTS DIALOGEX 0, 0, 305, 217
@@ -116,23 +118,39 @@
 EXSTYLE WS_EX_CONTROLPARENT
 FONT 8, "MS Shell Dlg", 400, 0, 0x1
 BEGIN
-    CONTROL         "Enable notifications",IDC_NOTIFICATIONS_ENABLE,"Button",BS_AUTOCHECKBOX | WS_TABSTOP,16,7,140,10
-    CONTROL         "Enable feeds",IDC_FEEDS_ENABLE,"Button",BS_AUTOCHECKBOX | WS_TABSTOP,16,17,140,10
-    GROUPBOX        "Timeouts",IDC_STATIC,6,32,115,59,NOT WS_VISIBLE
-    CONTROL         "Use default",IDC_TIMEOUT_DEFAULT,"Button",BS_AUTORADIOBUTTON | NOT WS_VISIBLE | WS_GROUP | WS_TABSTOP,16,46,53,10
-    CONTROL         "Custom",IDC_TIMEOUT_CUSTOM,"Button",BS_AUTORADIOBUTTON | NOT WS_VISIBLE | WS_TABSTOP,16,60,40,10
-    EDITTEXT        IDC_TIMEOUT,71,58,40,14,ES_AUTOHSCROLL | NOT WS_VISIBLE
-    CONTROL         "",IDC_TIMEOUT_SPIN,"msctls_updown32",UDS_SETBUDDYINT | UDS_ALIGNRIGHT | UDS_AUTOBUDDY | UDS_ARROWKEYS | NOT WS_VISIBLE,101,58,10,14
-    CONTROL         "Permanent",IDC_TIMEOUT_PERMANENT,"Button",BS_AUTORADIOBUTTON | NOT WS_VISIBLE | WS_TABSTOP,16,74,51,10
-    GROUPBOX        "Colors",IDC_STATIC,135,32,164,59,NOT WS_VISIBLE
-    CONTROL         "Use Windows colors",IDC_COL_WINDOWS,"Button",BS_AUTORADIOBUTTON | NOT WS_VISIBLE | WS_GROUP | WS_TABSTOP,145,46,79,10
-    CONTROL         "Use Popup colors",IDC_COL_POPUP,"Button",BS_AUTORADIOBUTTON | NOT WS_VISIBLE | WS_TABSTOP,145,60,71,10
-    CONTROL         "Use custom colors",IDC_COL_CUSTOM,"Button",BS_AUTORADIOBUTTON | NOT WS_VISIBLE | WS_TABSTOP,145,74,73,10
-    LTEXT           "Back",IDC_STATIC,233,64,16,8,NOT WS_VISIBLE
-    LTEXT           "Text",IDC_STATIC,265,64,16,8,NOT WS_VISIBLE
-    CONTROL         "",IDC_COLBACK,"ColourPicker",NOT WS_VISIBLE | WS_TABSTOP,229,73,24,13
-    CONTROL         "",IDC_COLTEXT,"ColourPicker",NOT WS_VISIBLE | WS_TABSTOP,261,73,24,13
-    PUSHBUTTON      "Preview",IDC_PREVIEW,128,99,50,14
+    CONTROL         "Notifications",IDC_NOTIFICATIONS_ENABLE,"Button",BS_AUTOCHECKBOX | WS_TABSTOP,26,35,80,8
+    CONTROL         "News feeds",IDC_FEEDS_ENABLE,"Button",BS_AUTOCHECKBOX | WS_TABSTOP,26,55,80,8
+    GROUPBOX        "Notify events",IDC_STATIC,16,7,280,109
+    EDITTEXT        IDC_TIMEOUT,243,35,34,14,ES_AUTOHSCROLL
+    CONTROL         "",IDC_TIMEOUT_SPIN,"msctls_updown32",UDS_SETBUDDYINT | UDS_ALIGNRIGHT | UDS_AUTOBUDDY | UDS_ARROWKEYS,276,35,11,14
+    LTEXT           "Text",IDC_STATIC,146,24,36,8
+    CONTROL         "",IDC_COLBACK,"ColourPicker",WS_TABSTOP,113,35,24,13
+    CONTROL         "",IDC_COLTEXT,"ColourPicker",WS_TABSTOP,143,35,24,13
+    PUSHBUTTON      "Preview",IDC_PREVIEW,124,139,50,14
+    RTEXT           "Back",IDC_STATIC,106,24,29,8
+    CONTROL         "Default",IDC_NOTIFICATIONS_DEFAULT,"Button",BS_AUTOCHECKBOX | BS_NOTIFY | WS_TABSTOP,174,37,50,8
+    RTEXT           "Timeout (sec.)",IDC_STATIC,174,14,113,8
+    CTEXT           "Colors",IDC_STATIC,106,14,68,8
+    CONTROL         "Client popups",IDC_CLIENT_ENABLE,"Button",BS_AUTOCHECKBOX | WS_TABSTOP,26,95,80,8
+    CONTROL         "Other events",IDC_OTHER_ENABLE,"Button",BS_AUTOCHECKBOX | WS_TABSTOP,26,75,80,8
+    RTEXT           "(0 = default, -1 = infinity)",IDC_STATIC,174,24,113,8
+    CONTROL         "",IDC_COLBACK2,"ColourPicker",WS_TABSTOP,113,55,24,13
+    CONTROL         "",IDC_COLTEXT2,"ColourPicker",WS_TABSTOP,143,55,24,13
+    CONTROL         "",IDC_COLBACK3,"ColourPicker",WS_TABSTOP,113,75,24,13
+    CONTROL         "",IDC_COLTEXT3,"ColourPicker",WS_TABSTOP,143,75,24,13
+    CONTROL         "",IDC_COLBACK4,"ColourPicker",WS_TABSTOP,113,95,24,13
+    CONTROL         "",IDC_COLTEXT4,"ColourPicker",WS_TABSTOP,143,95,24,13
+    CONTROL         "Default",IDC_FEEDS_DEFAULT,"Button",BS_AUTOCHECKBOX | BS_NOTIFY | WS_TABSTOP,174,57,50,8
+    CONTROL         "Default",IDC_OTHER_DEFAULT,"Button",BS_AUTOCHECKBOX | BS_NOTIFY | WS_TABSTOP,174,77,50,8
+    CONTROL         "Default",IDC_CLIENT_DEFAULT,"Button",BS_AUTOCHECKBOX | BS_NOTIFY | WS_TABSTOP,174,97,50,8
+    EDITTEXT        IDC_TIMEOUT2,243,55,34,14,ES_AUTOHSCROLL
+    CONTROL         "",IDC_TIMEOUT_SPIN2,"msctls_updown32",UDS_SETBUDDYINT | UDS_ALIGNRIGHT | UDS_AUTOBUDDY | UDS_ARROWKEYS,276,55,11,14
+    EDITTEXT        IDC_TIMEOUT3,243,75,34,14,ES_AUTOHSCROLL
+    CONTROL         "",IDC_TIMEOUT_SPIN3,"msctls_updown32",UDS_SETBUDDYINT | UDS_ALIGNRIGHT | UDS_AUTOBUDDY | UDS_ARROWKEYS,276,75,11,14
+    EDITTEXT        IDC_TIMEOUT4,243,95,34,14,ES_AUTOHSCROLL
+    CONTROL         "",IDC_TIMEOUT_SPIN4,"msctls_updown32",UDS_SETBUDDYINT | UDS_ALIGNRIGHT | UDS_AUTOBUDDY | UDS_ARROWKEYS,276,95,11,14
+    CONTROL         "Use balloon notifications in systray instead of Popups",IDC_SYSTRAY_NOTIFY,
+                    "Button",BS_AUTOCHECKBOX | WS_TABSTOP,26,123,261,8
 END
 
 IDD_INFO DIALOGEX 0, 0, 325, 197
@@ -177,16 +195,26 @@
         VERTGUIDE, 248
         VERTGUIDE, 255
         TOPMARGIN, 7
-        BOTTOMMARGIN, 220
+        BOTTOMMARGIN, 226
     END
 
     IDD_OPTIONS_EVENTS, DIALOG
     BEGIN
         LEFTMARGIN, 6
         RIGHTMARGIN, 299
-        VERTGUIDE, 16
+        VERTGUIDE, 26
+        VERTGUIDE, 106
+        VERTGUIDE, 174
+        VERTGUIDE, 287
+        VERTGUIDE, 296
         TOPMARGIN, 7
         BOTTOMMARGIN, 210
+        HORZGUIDE, 14
+        HORZGUIDE, 32
+        HORZGUIDE, 35
+        HORZGUIDE, 55
+        HORZGUIDE, 75
+        HORZGUIDE, 95
     END
 
     IDD_INFO, DIALOG
Index: json.cpp
===================================================================
--- json.cpp	(revision 88)
+++ json.cpp	(working copy)
@@ -162,38 +162,47 @@
 				notification->text = utils::text::slashu_to_utf8(
 					utils::text::special_expressions_decode(
 						utils::text::remove_html( text.Value( ) ) ) );
+				
+				notification->url = utils::text::special_expressions_decode( link.Value( ) );
 
-				notification->link = utils::text::special_expressions_decode( link.Value( ) );
-
 				notifications->push_back( notification );
 			}
-			else if ( type.Value( ) == "typ" )
+			else if ( type.Value( ) == "typ" ) // typing notify
 			{
 				const Number& from = objMember["from"];
-				char user_id[32];
-				lltoa( from.Value(), user_id, 10 );
-
+				char was_id[32];
+				lltoa( from.Value(), was_id, 10 );
+				
 				facebook_user fbu;
-				fbu.user_id = user_id;
+				fbu.user_id = was_id;
 
 				HANDLE hContact = proto->AddToContactList(&fbu);
 				DBWriteContactSettingDword(hContact,proto->m_szModuleName,"Status",ID_STATUS_ONLINE);
 
-				const Number& state = objMember["st"];
-				if (state.Value() == 1)
+				const Number& st = objMember["st"];
+				if (st.Value() == 1){ // started typing
 					CallService(MS_PROTO_CONTACTISTYPING, (WPARAM)hContact, (LPARAM)60);
-				else
+				} else { // stoped typing
 					CallService(MS_PROTO_CONTACTISTYPING, (WPARAM)hContact, (LPARAM)PROTOTYPE_CONTACTTYPING_OFF);
+				}
+
 			}
 			else if ( type.Value( ) == "inbox" )
 			{
-/*				const Number& unseen = objMember["unseen"];
+				const Number& unseen = objMember["unseen"];
+        TCHAR info[512];
 
-				TCHAR* info = TranslateT("You have %d unseen messages");
-				proto->ShowEvent( TranslateT("Unseen messages"), TC );
-*/			}
+        char num[32];
+				lltoa( unseen.Value(), num, 10 );
+
+        mir_sntprintf(info, 500, TranslateT("You have %s unseen messages"), num);
+
+				proto->NotifyEvent(TranslateT("Unseen messages"), info, 0, FACEBOOK_EVENT_OTHER, reinterpret_cast<TCHAR *> ( FACEBOOK_URL_MESSAGES ) );
+				mir_free(info);
+			}
 			else
 				continue;
+
 		}
 	}
 	catch (Reader::ParseException& e)
Index: messages.cpp
===================================================================
--- messages.cpp	(revision 88)
+++ messages.cpp	(working copy)
@@ -27,19 +27,52 @@
 
 #include "common.h"
 
+struct send_direct
+{
+	send_direct(HANDLE hContact,const std::string &msg) : hContact(hContact),msg(msg) {}
+	HANDLE hContact;
+	std::string msg;
+};
+
+struct send_typing
+{
+	send_typing(HANDLE hContact,const int status) : hContact(hContact),status(status) {}
+	HANDLE hContact;
+	int status;
+};
+
 int FacebookProto::RecvMsg(HANDLE hContact, PROTORECVEVENT *pre)
 {
+	// close fb chat window
+	DBVARIANT dbv;
+	if( !DBGetContactSettingString(hContact,m_szModuleName,FACEBOOK_KEY_ID,&dbv) )
+	{
+		std::string* data = new std::string( dbv.pszVal );
+		ForkThread( &FacebookProto::CloseChatWorker, this, ( void *)data);		
+		DBFreeVariant(&dbv);
+	}
+
+	// end typing
+	CallService(MS_PROTO_CONTACTISTYPING, (WPARAM)hContact, (LPARAM)PROTOTYPE_CONTACTTYPING_OFF);
+
 	CCSDATA ccs = { hContact,PSR_MESSAGE,0,reinterpret_cast<LPARAM>(pre) };
 	return CallService(MS_PROTO_RECVMSG,0,reinterpret_cast<LPARAM>(&ccs));
 }
 
-struct send_direct
+void FacebookProto::CloseChatWorker(void *p)
 {
-	send_direct(HANDLE hContact,const std::string &msg) : hContact(hContact),msg(msg) {}
-	HANDLE hContact;
-	std::string msg;
-};
+	if ( DBGetContactSettingByte(NULL, facy.parent->m_szModuleName, FACEBOOK_KEY_CLOSE_CHAT_ENABLE, DEFAULT_CLOSE_CHAT_ENABLE ) != TRUE )
+		return ;
 
+	if (p == NULL)
+		return ;
+
+	std::string* message_recipient = (std::string*)p;
+	facy.close_chat( *message_recipient );
+
+	delete p;
+}
+
 void FacebookProto::SendMsgWorker(void *p)
 {
 	if(p == NULL)
@@ -50,10 +83,14 @@
 	DBVARIANT dbv;
 	if( !DBGetContactSettingString(data->hContact,m_szModuleName,FACEBOOK_KEY_ID,&dbv) )
 	{
-		facy.send_message(dbv.pszVal, data->msg);
-
-		ProtoBroadcastAck(m_szModuleName,data->hContact,ACKTYPE_MESSAGE,ACKRESULT_SUCCESS,
-			(HANDLE)1,0);
+		if ( facy.send_message(dbv.pszVal, data->msg) )
+    {
+      ProtoBroadcastAck(m_szModuleName,data->hContact,ACKTYPE_MESSAGE,ACKRESULT_SUCCESS, (HANDLE)1,0);
+    } else {
+      LPARAM msg = (LPARAM)_strdup((char*)CallService(MS_LANGPACK_TRANSLATESTRING,0,(LPARAM)"Error with sending message."));
+      ProtoBroadcastAck(m_szModuleName,data->hContact,ACKTYPE_MESSAGE,ACKRESULT_FAILED, (HANDLE)1,msg);
+		  mir_free((char *)msg);
+    }
 		DBFreeVariant(&dbv);
 	}
 
@@ -63,17 +100,68 @@
 int FacebookProto::SendMsg(HANDLE hContact, int flags, const char *msg)
 {
 	if ( !isOnline( ) )
+	{
+		LPARAM msg = (LPARAM)_strdup((char*)CallService(MS_LANGPACK_TRANSLATESTRING,0,(LPARAM)"You cannot send messages when you are offline."));
+		ProtoBroadcastAck(m_szModuleName, hContact, ACKTYPE_MESSAGE, ACKRESULT_FAILED, (HANDLE)1, msg);
+		mir_free((char *)msg);
 		return 0;
+	}
 
 	if ( DBGetContactSettingWord( hContact, m_szModuleName, "Status", ID_STATUS_OFFLINE ) == ID_STATUS_OFFLINE )
+	{
+		LPARAM msg = (LPARAM)_strdup((char*)CallService(MS_LANGPACK_TRANSLATESTRING,0,(LPARAM)"Facebook protocol don't support offline messages."));
+		ProtoBroadcastAck(m_szModuleName, hContact, ACKTYPE_MESSAGE, ACKRESULT_FAILED, (HANDLE)1, msg);
+		mir_free((char *)msg);
 		return 0;
+	}
 
 	// TODO: msg comes as Unicode (retyped wchar_t*), why should we convert it as ANSI to UTF-8? o_O
 	if ( flags & PREF_UNICODE )
         msg = mir_utf8encode(msg);
 
-
 	ForkThread(&FacebookProto::SendMsgWorker, this,new send_direct(hContact,msg));
-
 	return 1;
 }
+
+void FacebookProto::SendTypingWorker(void *p)
+{
+	if(p == NULL)
+		return;
+
+	send_typing *typing = static_cast<send_typing*>(p);
+
+		
+	DBVARIANT dbv;
+	if( !DBGetContactSettingString(typing->hContact,m_szModuleName,FACEBOOK_KEY_ID,&dbv) )
+	{
+		std::string data = "typ=";
+		data += ( typing->status == PROTOTYPE_SELFTYPING_ON ) ? "1" : "0"; // PROTOTYPE_SELFTYPING_OFF
+		data += "&to=";
+		data += dbv.pszVal;
+		data += "&source=chat";
+    data += "&fb_dtsg=" + facy.dtsg_;
+		data += "&post_form_id=";
+		data += ( facy.post_form_id_.length( ) ) ? facy.post_form_id_ : "0";
+		data += "&post_form_id_source=AsyncRequest";
+
+// RM TODO: pokud offline:1  ... user is offline...   ale spÌö asi ne, protoûe to Ëasto na fb jebe, û eto ¯ekne ûe je off ikdyû vlastnÏ nenÌ...
+    // for (;;);{"error":0,"errorSummary":"","errorDescription":"","errorIsWarning":false,"silentError":0,"payload":{"offline":1}}
+
+
+		http::response resp = facy.flap( FACEBOOK_REQUEST_TYPING, &data );
+
+		DBFreeVariant(&dbv);
+	}		
+
+	delete typing;
+}
+
+int FacebookProto::UserIsTyping(HANDLE hContact,int type)
+{ 
+	if (hContact && isOnline())
+	{
+		ForkThread(&FacebookProto::SendTypingWorker, this,new send_typing(hContact,type));		
+	}
+
+	return 0;
+}
\ No newline at end of file
Index: process.cpp
===================================================================
--- process.cpp	(revision 88)
+++ process.cpp	(working copy)
@@ -3,7 +3,7 @@
 Facebook plugin for Miranda Instant Messenger
 _____________________________________________
 
-Copyright © 2009-10 Michal Zelinka
+Copyright ¬© 2009-10 Michal Zelinka
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
@@ -129,12 +129,16 @@
 			LOG("      Got notification: %s", notifications[i]->text.c_str());
 			TCHAR* szTitle = mir_a2t_cp(this->m_szModuleName, CP_UTF8);
 			TCHAR* szText = mir_a2t_cp(notifications[i]->text.c_str(), CP_UTF8);
-			NotifyEvent( szTitle, szText );
+			TCHAR* szUrl = mir_a2t_cp(notifications[i]->url.c_str(), CP_UTF8);
+			NotifyEvent( szTitle, szText, 0, FACEBOOK_EVENT_NOTIFICATION, szUrl );
 			mir_free( szTitle );
 			mir_free( szText );
+			mir_free(szTitle);
+			mir_free(szText);
+			// mir_free(szUrl); // url se uvoln√≠ p≈ôi uvolnƒõn√≠ popupu
 		}
-		delete notifications[i];
 	}
+	notifications.clear();
 
 	LOG("***** Messages processed");
 
@@ -164,6 +168,7 @@
 	std::vector< facebook_newsfeed* > news;
 
 	std::string::size_type pos = 0;
+	std::string::size_type pos2 = 0;
 	std::string::size_type end = 0;
 	UINT limit = 0;
 
@@ -181,14 +186,27 @@
 		    utils::text::special_expressions_decode(
 		        utils::text::remove_html( resp->substr( pos, end-pos ) ) ) );
 
-		pos = end + 6;
+		pos = end + 5;
 		end = resp->find( "<\\/h6>", pos );
 		if ( end == std::string::npos ){
 			delete nf; break;}
-		nf->text = utils::text::slashu_to_utf8(
-		    utils::text::special_expressions_decode(
-		        utils::text::remove_html( resp->substr( pos, end-pos ) ) ) );
 
+		nf->text = utils::text::trim(
+			utils::text::slashu_to_utf8(
+				utils::text::special_expressions_decode(
+					utils::text::remove_html( resp->substr( pos, end-pos ) ) ) ) );
+		// O≈ô√≠znut√≠ moc dlouh√©ho textu...
+		if (nf->text.length() > 420) nf->text = nf->text.substr(0, 420);
+
+		// Parsov√°n√≠ odkazu, pos2 proto≈æe kdy≈æ se tam ulo≈æ√≠ npos, "zacykl√≠" se to a mƒõ se nechtƒõlo p≈ôem√Ω≈°let jestli by to ≈°lo jinak
+		pos2 = resp->find( "uiStreamSource", pos );
+		pos2 = resp->find( "href=", pos2 );
+		if ( pos2 != std::string::npos ){
+			pos2 += 7;
+			end = resp->find( "\">", pos2 ) - 1;
+			nf->url = utils::text::special_expressions_decode(  resp->substr( pos2, end-pos2 ) );
+		}
+
 		if ( nf->text.length( ) > 0 )
 			news.push_back( nf );
 		else
@@ -203,10 +221,12 @@
 		LOG("      Got newsfeed: %s %s", news[i]->title.c_str(), news[i]->text.c_str());
 		TCHAR* szTitle = mir_a2t_cp(news[i]->title.c_str(), CP_UTF8);
 		TCHAR* szText = mir_a2t_cp(news[i]->text.c_str(), CP_UTF8);
-		NotifyEvent(szTitle,szText);
+		HANDLE hContact = ContactIDToHContact(news[i]->user_id.c_str());
+		TCHAR* szUrl = mir_a2t_cp(news[i]->url.c_str(), CP_UTF8);
+		NotifyEvent(szTitle,szText,hContact,FACEBOOK_EVENT_NEWSFEED, szUrl);
 		mir_free(szTitle);
 		mir_free(szText);
-		delete news[i];
+		//mir_free(szUrl); // url neuvolnovat, a≈æ v popupu
 	}
 	news.clear();
 
@@ -227,9 +247,6 @@
 
 void FacebookProto::ProcessAvatar(HANDLE hContact,const std::string* url,bool force)
 {
-	if ( !isOnline( ) )
-		return;
-
 	ForkThread(&FacebookProto::UpdateAvatarWorker, this,
 	    new update_avatar(hContact,(*url)));
 }
Index: proto.cpp
===================================================================
--- proto.cpp	(revision 88)
+++ proto.cpp	(working copy)
@@ -59,6 +59,7 @@
 	HookProtoEvent(ME_CLIST_PREBUILDSTATUSMENU,  &FacebookProto::OnBuildStatusMenu,  this);
 	HookProtoEvent(ME_CLIST_PREBUILDCONTACTMENU, &FacebookProto::OnBuildContactMenu, this);
 	HookProtoEvent(ME_OPT_INITIALISE,            &FacebookProto::OnOptionsInit,      this);
+	HookProtoEvent(ME_IDLE_CHANGED,              &FacebookProto::OnIdleChanged,		 this);
 
 	// Create standard network connection
 	TCHAR descr[512];
@@ -111,6 +112,7 @@
 	CloseHandle( this->avatar_lock_ );
 	CloseHandle( this->log_lock_ );
 	CloseHandle( this->facy.buddies_lock_ );
+	CloseHandle( this->updateloop_lock_ );
 
 	mir_free( m_tszUserName );
 	mir_free( m_szModuleName );
@@ -133,7 +135,7 @@
 	case PFLAGNUM_3:
 		return PF2_ONLINE;
 	case PFLAGNUM_4:
-		return PF4_NOCUSTOMAUTH | PF4_SUPPORTIDLE | PF4_IMSENDUTF | PF4_AVATARS | PF4_SUPPORTTYPING;
+		return PF4_FORCEAUTH | PF4_NOCUSTOMAUTH | PF4_SUPPORTIDLE | PF4_IMSENDUTF | PF4_AVATARS | PF4_SUPPORTTYPING | PF4_NOAUTHDENYREASON | PF4_IMSENDOFFLINE;
 	case PFLAG_MAXLENOFMESSAGE:
 		return FACEBOOK_MESSAGE_LIMIT;
 	case PFLAG_UNIQUEIDTEXT:
@@ -312,6 +314,20 @@
 	return 0;
 }
 
+int FacebookProto::OnIdleChanged(WPARAM wParam,LPARAM lParam)
+{
+// stejnƒõ se to ku*va nikdy nevol√° :( :D
+  if (!(lParam & IDF_PRIVACY) && (lParam & IDF_ISIDLE)) {
+		facy.idle_ = true;
+	    Log("Swiched to IDLE+");
+	} else {
+		facy.idle_ = false;
+	    Log("Swiched back from IDLE+");
+    	facy.reconnect(); // "reconnect" into online state
+	}
+	return 0;
+}
+
 int FacebookProto::OnBuildStatusMenu(WPARAM wParam,LPARAM lParam)
 {
 	char text[200];
Index: proto.h
===================================================================
--- proto.h	(revision 88)
+++ proto.h	(working copy)
@@ -3,7 +3,7 @@
 Facebook plugin for Miranda Instant Messenger
 _____________________________________________
 
-Copyright © 2009-10 Michal Zelinka
+Copyright ¬© 2009-10 Michal Zelinka
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
@@ -120,6 +120,7 @@
 	// Events
 	int  __cdecl OnModulesLoaded(WPARAM, LPARAM);
 	int  __cdecl OnOptionsInit(WPARAM, LPARAM);
+	int  __cdecl OnIdleChanged(WPARAM, LPARAM);
 	int  __cdecl OnBuildStatusMenu(WPARAM wParam,LPARAM lParam);
 	int  __cdecl OnBuildContactMenu(WPARAM,LPARAM);
 	int  __cdecl OnContactDeleted(WPARAM,LPARAM);
@@ -147,6 +148,9 @@
 	void __cdecl UpdateContactWorker(void *);
 	void __cdecl UpdateAvatarWorker(void *);
 	void __cdecl SendMsgWorker(void *);
+	
+	void __cdecl SendTypingWorker(void *);
+	void __cdecl CloseChatWorker(void *);
 
 	// Contacts handling
 	bool    IsMyContact(HANDLE);
@@ -161,6 +165,7 @@
 
 	// Helpers
 	std::string GetAvatarFolder();
+	bool AvatarExists(facebook_user* fbu);
 	void ToggleStatusMenuItems( BOOL bEnable );
 
 	// Handles, Locks
@@ -170,6 +175,8 @@
 	HANDLE  signon_lock_;
 	HANDLE  avatar_lock_;
 	HANDLE  log_lock_;
+	HANDLE  updateloop_lock_;
+	HANDLE  messageloop_lock_;
 
 	HANDLE  m_hNetlibUser;
 	HANDLE  m_hUpdLoop;
@@ -182,5 +189,5 @@
 
 	// Information providing
 	int Log(const char *fmt,...);
-	int NotifyEvent(TCHAR* title, TCHAR* info, HANDLE contact=NULL, DWORD flags=NIIF_INFO);
+	int NotifyEvent(TCHAR* title, TCHAR* info, HANDLE contact=NULL, DWORD flags=NIIF_INFO, TCHAR* url=NULL);
 };
Index: resource.h
===================================================================
--- resource.h	(revision 88)
+++ resource.h	(working copy)
@@ -22,10 +22,12 @@
 #define IDC_SET_STATUS                  1125
 #define IDC_LOGGING                     1026
 #define IDC_COOKIES                     1027
+#define IDC_CLOSE_CHAT                  1027
 #define IDC_DEBUGINFO                   1041
 #define IDC_NOTIFICATIONS_ENABLE        1051
 #define IDC_FEEDS_ENABLE                1052
 #define IDC_TIMEOUT_DEFAULT             1053
+#define IDC_SYSTRAY_NOTIFY              1053
 #define IDC_TIMEOUT_CUSTOM              1054
 #define IDC_TIMEOUT                     1055
 #define IDC_TIMEOUT_SPIN                1056
@@ -36,6 +38,26 @@
 #define IDC_COLBACK                     1061
 #define IDC_COLTEXT                     1062
 #define IDC_PREVIEW                     1063
+#define IDC_NOTIFICATIONS_DEFAULT       1064
+#define IDC_CLIENT_ENABLE2              1065
+#define IDC_CLIENT_ENABLE               1065
+#define IDC_OTHER_ENABLE                1066
+#define IDC_COLBACK2                    1067
+#define IDC_COLTEXT2                    1068
+#define IDC_COLBACK3                    1073
+#define IDC_COLTEXT3                    1074
+#define IDC_COLBACK4                    1077
+#define IDC_COLTEXT4                    1078
+#define IDC_FEEDS_DEFAULT               1079
+#define IDC_OTHER_DEFAULT               1080
+#define IDC_CLIENT_DEFAULT              1081
+#define IDC_TIMEOUT2                    1082
+#define IDC_TIMEOUT_SPIN2               1083
+#define IDC_TIMEOUT3                    1084
+#define IDC_TIMEOUT_SPIN3               1085
+#define IDC_TIMEOUT4                    1086
+#define IDC_TIMEOUT_SPIN4               1087
+#define IDC_USE_HTTPS                   1101
 
 // Next default values for new objects
 // 
@@ -43,7 +65,7 @@
 #ifndef APSTUDIO_READONLY_SYMBOLS
 #define _APS_NEXT_RESOURCE_VALUE        121
 #define _APS_NEXT_COMMAND_VALUE         40001
-#define _APS_NEXT_CONTROL_VALUE         1101
+#define _APS_NEXT_CONTROL_VALUE         1102
 #define _APS_NEXT_SYMED_VALUE           131
 #endif
 #endif
Index: stubs.cpp
===================================================================
--- stubs.cpp	(revision 88)
+++ stubs.cpp	(working copy)
@@ -3,7 +3,7 @@
 Facebook plugin for Miranda Instant Messenger
 _____________________________________________
 
-Copyright © 2009-10 Michal Zelinka
+Copyright ¬© 2009-10 Michal Zelinka
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
@@ -137,8 +137,3 @@
 {
 	return 0;
 }
-
-int FacebookProto::UserIsTyping(HANDLE hContact,int type)
-{ 
-	return 0;
-}
Index: utils.cpp
===================================================================
--- utils.cpp	(revision 88)
+++ utils.cpp	(working copy)
@@ -232,7 +232,7 @@
 	GetSystemTime( &time );
 
 	std::ofstream out( path.c_str(), std::ios_base::out | std::ios_base::app | std::ios_base::ate );
-	out << "[" << time.wHour << ":" << time.wMinute << ":" << time.wSecond << "] " << text << std::endl;
+	out << "[" << (time.wHour < 10 ? "0" : "") << time.wHour << ":" << (time.wMinute < 10 ? "0" : "") << time.wMinute << ":" << (time.wSecond < 10 ? "0" : "") << time.wSecond << "] " << text << std::endl;
 	out.close( );
 
 	return EXIT_SUCCESS;
